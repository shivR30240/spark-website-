<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartClass - Role Selection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f1020;
            --card: #0b1220;
            --accent1: #6EE7B7;
            --accent2: #7C4DFF;
            --neon: #00FFE1;
            --glass: rgba(255, 255, 255, 0.04);
            --muted: #bfc7d6;
            --radius: 14px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .camera-container {
            position: relative;
            width: 100%;
            padding-bottom: 60%;
        }

        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1.5rem;
            background-color: black;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .attendance-marker {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Neon Rescheduler Styles */
        .panel {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border: 1px solid rgba(124, 77, 255, 0.09);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.6), 0 0 30px rgba(124, 77, 255, 0.04) inset;
        }

        .input,
        select,
        textarea {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 10px 12px;
            border-radius: 10px;
            color: #eaf6ff;
            outline: none;
        }

        .btn {
            background: linear-gradient(90deg, var(--accent2), var(--accent1));
            border: none;
            color: #041024;
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 6px 16px rgba(124, 77, 255, 0.18);
        }

        .subject-chip {
            background: linear-gradient(90deg, rgba(124, 77, 255, 0.12), rgba(110, 231, 183, 0.06));
            border-radius: 10px;
            padding: 8px;
            min-width: 260px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            color: var(--neon);
            font-size: 13px;
        }

        table.grid {
            width: 100%;
            border-collapse: collapse;
        }

        table.grid th,
        table.grid td {
            border: 1px solid rgba(255, 255, 255, 0.04);
            padding: 10px;
            text-align: center;
            font-size: 14px;
        }

        .badge {
            padding: 6px 10px;
            border-radius: 999px;
            background: linear-gradient(90deg, #00ffe1, #7c4dff);
            color: #041018;
            font-weight: 700;
            font-size: 13px;
            box-shadow: 0 8px 18px rgba(124, 77, 255, 0.08);
        }

        /* Login Cards Hover Effects */
        .login-card {
            transition: all 0.3s ease;
            transform: translateY(0);
        }

        .login-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        /* Editable Timetable Styles */
        [contenteditable="true"] {
            outline: none;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        [contenteditable="true"]:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        [contenteditable="true"]:focus {
            background-color: rgba(255, 255, 255, 0.15);
            border: 1px dashed rgba(124, 77, 255, 0.5);
        }

        .timetable-entry {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .timetable-entry:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .edit-entry-btn, .delete-entry-btn {
            transition: all 0.2s;
        }

        .edit-entry-btn:hover, .delete-entry-btn:hover {
            transform: scale(1.1);
        }
    </style>

    <!-- Gemini AI Integration - Added by Gemini Code Embedder -->
    <script type="importmap">
  {
    "imports": {
      "@google/generative-ai": "https://esm.run/@google/generative-ai"
    }
  }
</script>

    <script type="module">


        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Initialize the Gemini API
        const API_KEY = "AIzaSyBL5WEv1PCJmM0BAs1GzOixXLE5yUeFs8w";
        const genAI = new GoogleGenerativeAI(API_KEY);

        // Get the Gemini Pro model
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });



        // Chat history for context-aware conversations
        let chatHistory = [];

        // Start a chat session
        const chat = model.startChat({
            history: chatHistory,
            generationConfig: {
                maxOutputTokens: 2048,
                temperature: 0.7,
            },
        });

        // Function to send a message to Gemini
        async function sendMessageToGemini(userMessage) {
            try {
                const result = await chat.sendMessage(userMessage);
                const response = await result.response;
                return response.text();
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw error;
            }
        }

        // Function for single prompts (no chat history)
        async function generateContent(prompt) {
            try {
                const result = await model.generateContent(prompt);
                const response = await result.response;
                return response.text();
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw error;
            }
        }

        // Make functions available globally
        window.geminiAI = {
            sendMessage: sendMessageToGemini,
            generate: generateContent,
            model: model,
            chat: chat
        };

        console.log("‚úÖ Gemini AI initialized successfully!");
        console.log("üìù Usage: await window.geminiAI.sendMessage('Your message')");
        console.log("üìù Usage: await window.geminiAI.generate('Your prompt')");
    </script>

    <style>
        /* Gemini Chat Widget Styles */
        .gemini-chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 500px;
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 40px rgba(79, 172, 254, 0.1);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            z-index: 9999;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gemini-chat-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .gemini-chat-header h3 {
            margin: 0;
            color: #0a0a1a;
            font-size: 16px;
            font-weight: 600;
        }

        .gemini-chat-header .gemini-icon {
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gemini-chat-messages {
            height: 320px;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .gemini-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .gemini-message.user {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #0a0a1a;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .gemini-message.assistant {
            background: rgba(255, 255, 255, 0.08);
            color: #e0e0e0;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gemini-chat-input-container {
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 10px;
        }

        .gemini-chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .gemini-chat-input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }

        .gemini-chat-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .gemini-send-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 10px;
            color: #0a0a1a;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .gemini-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4);
        }

        .gemini-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .gemini-typing {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .gemini-typing span {
            width: 8px;
            height: 8px;
            background: #4facfe;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .gemini-typing span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .gemini-typing span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .gemini-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(79, 172, 254, 0.4);
            z-index: 9998;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gemini-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(79, 172, 254, 0.5);
        }

        .gemini-toggle-btn svg {
            width: 28px;
            height: 28px;
            fill: #0a0a1a;
        }
    </style>
</head>

<body class="bg-gray-900 min-h-screen text-white">
    <!-- Role Selection Screen -->
    <div id="role-selection" class="container mx-auto px-4 py-12 text-center">
        <div class="mb-12">
            <i class="fas fa-graduation-cap text-6xl text-blue-400 mb-4"></i>
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Welcome to Spark</h1>
            <p class="text-xl text-gray-400">Select your role to login</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
            <!-- Student Card -->
            <div class="login-card bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700 cursor-pointer"
                onclick="selectRole('student')">
                <div class="text-5xl text-blue-400 mb-4">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Student</h2>
                <p class="text-gray-400 mb-6">Access attendance, timetable, and personalized suggestions.</p>
                <button
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full font-semibold transition">Login
                    as Student</button>
            </div>
            <!-- Teacher Card -->
            <div class="login-card bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700 cursor-pointer"
                onclick="selectRole('teacher')">
                <div class="text-5xl text-green-400 mb-4">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Teacher</h2>
                <p class="text-gray-400 mb-6">Mark attendance, view class schedules, and manage rescheduling.</p>
                <button
                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-full font-semibold transition">Login
                    as Teacher</button>
            </div>
            <!-- Admin Card -->
            <div class="login-card bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700 cursor-pointer"
                onclick="selectRole('admin')">
                <div class="text-5xl text-purple-400 mb-4">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Administrator</h2>
                <p class="text-gray-400 mb-6">Manage users, oversee attendance, and system settings.</p>
                <button
                    class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-full font-semibold transition">Login
                    as Admin</button>
            </div>
        </div>
    </div>

    <!-- Student Dashboard (Hidden Initially) -->
    <div id="student-dashboard" class="hidden">
        <!-- Navigation Bar -->
        <nav class="bg-blue-600 text-white shadow-lg">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-graduation-cap text-2xl"></i>
                        <span class="text-xl font-bold">Spark</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="hidden md:flex flex-col text-right">
                            <span class="font-semibold" id="nav-username">User</span>
                            <span class="text-sm text-blue-200" id="nav-class">Computer Science</span>
                        </div>
                        <img id="nav-profile-photo" class="h-10 w-10 rounded-full border-2 border-white object-cover"
                            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366F1'%3E%3Cpath d='M12 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0 2c-6.627 0-12 5.373-12 12h24c0-6.627-5.373-12-12-12z'/%3E%3C/svg%3E"
                            alt="Profile">
                        <button class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded-lg transition"
                            onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Mobile Tabs -->
        <div class="bg-gray-800 shadow-md md:hidden">
            <div class="flex overflow-x-auto">
                <button class="tab-btn px-4 py-3 font-medium text-blue-400 border-b-2 border-blue-400"
                    data-tab="dashboard" id="dashboard-tab-btn-mobile">
                    <i class="fas fa-home mr-2"></i>Dashboard
                </button>
                <button class="tab-btn px-4 py-3 font-medium text-gray-400" data-tab="attendance">
                    <i class="fas fa-fingerprint mr-2"></i>Attendance
                </button>
                <button class="tab-btn px-4 py-3 font-medium text-gray-400" data-tab="timetable">
                    <i class="fas fa-calendar-alt mr-2"></i>Timetable
                </button>
                
                <button class="tab-btn px-4 py-3 font-medium text-gray-400" data-tab="suggestions">
                    <i class="fas fa-lightbulb mr-2"></i>Suggestions
                </button>
            </div>
        </div>

        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Sidebar (Desktop) -->
                <div class="hidden md:block w-full md:w-1/4 lg:w-1/5">
                    <div class="bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                        <div class="flex flex-col items-center text-center mb-6">
                            <img id="sidebar-profile-photo" class="h-24 w-24 rounded-full mb-4 border-4 border-blue-500 object-cover"
                                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366F1'%3E%3Cpath d='M12 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0 2c-6.627 0-12 5.373-12 12h24c0-6.627-5.373-12-12-12z'/%3E%3C/svg%3E"
                                alt="Profile">
                            <h2 class="text-xl font-bold" id="sidebar-username">User</h2>
                            <p class="text-gray-400" id="sidebar-id">BATCH</p>
                            <div class="mt-2 bg-green-800 text-green-200 text-xs px-2 py-1 rounded-full">ID Verified
                            </div>
                        </div>

                        <nav class="space-y-2">
                            <button
                                class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-blue-400 bg-blue-900"
                                data-tab="dashboard" id="dashboard-tab-btn">
                                <i class="fas fa-home mr-3"></i>Dashboard
                            </button>
                            <button
                                class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700"
                                data-tab="attendance">
                                <i class="fas fa-fingerprint mr-3"></i>Attendance
                            </button>
                            <button
                                class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700"
                                data-tab="timetable">
                                <i class="fas fa-calendar-alt mr-3"></i>Timetable
                            </button>
                            <button
                                class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700"
                                data-tab="rescheduler">
                                <i class="fas fa-exchange-alt mr-3"></i>Rescheduler
                            </button>
                            <button
                                class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700"
                                data-tab="suggestions">
                                <i class="fas fa-lightbulb mr-3"></i>Suggestions
                            </button>
                            <button
                                class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700"
                                data-tab="profile">
                                <i class="fas fa-user mr-3"></i>Profile
                            </button>
                            <button
                                class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700"
                                data-tab="routine">
                                <i class="fas fa-clock mr-3"></i>Daily Routine
                            </button>
                        </nav>
                    </div>

                    <div class="bg-gray-800 rounded-lg shadow-md p-4">
                        <h3 class="font-bold text-lg mb-3">Today's Schedule</h3>
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <div class="bg-blue-900 text-blue-200 text-xs font-bold px-2 py-1 rounded mr-3">9:00
                                </div>
                                <div>
                                    <div class="font-medium">Data Structures</div>
                                    <div class="text-xs text-gray-400">Room 302</div>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="bg-blue-900 text-blue-200 text-xs font-bold px-2 py-1 rounded mr-3">10:00
                                </div>
                                <div>
                                    <div class="font-medium">Algorithms</div>
                                    <div class="text-xs text-gray-400">Room 305</div>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="bg-green-900 text-green-200 text-xs font-bold px-2 py-1 rounded mr-3">11:00
                                </div>
                                <div>
                                    <div class="font-medium">Free Period</div>
                                    <div class="text-xs text-gray-400">Library</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="w-full md:w-3/4 lg:w-4/5">
                    <!-- Authentication Screens -->
                    <div id="auth-screens">
                        <!-- Home Screen -->
                        <div id="home-screen" class="bg-gray-800 p-6 rounded-lg shadow-md">
                            <header class="text-center mb-8">
                                <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">Secure Face Recognition</h1>
                                <p class="text-gray-400">Registration, Login & Location Verification</p>
                            </header>

                            <div class="space-y-6">
                                <p class="text-center text-gray-400">Welcome! Use your face to register or log in.</p>
                                <div
                                    class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 justify-center">
                                    <button onclick="showRegister()"
                                        class="w-full md:w-auto px-8 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition transform hover:scale-105 shadow-lg">Register</button>
                                    <button onclick="showLogin()"
                                        class="w-full md:w-auto px-8 py-3 bg-gray-700 text-white rounded-full font-semibold hover:bg-gray-600 transition transform hover:scale-105">Log
                                        In</button>
                                </div>
                            </div>
                        </div>

                        <!-- Register Screen -->
                        <div id="register-screen" class="hidden bg-gray-800 p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-semibold text-center mb-6">New User Registration</h2>
                            <div class="camera-container rounded-3xl overflow-hidden mb-6 shadow-md mx-auto"
                                style="max-width: 500px;">
                                <video id="video-reg" class="block bg-black"></video>
                                <canvas id="canvas-reg" class="block"></canvas>
                            </div>
                            <div class="space-y-4">
                                <input type="text" id="username-input" placeholder="Enter your username"
                                    class="w-full p-3 rounded-full border border-gray-600 bg-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                                <button id="register-btn"
                                    class="w-full px-8 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-green-700 transition transform hover:scale-105 shadow-lg"
                                    disabled>Capture Face and Register</button>
                            </div>
                            <button onclick="goHome()"
                                class="mt-4 text-sm text-blue-400 hover:text-blue-300 transition duration-200">&larr;
                                Back to
                                Home</button>
                        </div>

                        <!-- Login Screen -->
                        <div id="login-screen" class="hidden bg-gray-800 p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-semibold text-center mb-6">User Login</h2>
                            <div class="camera-container rounded-3xl overflow-hidden mb-6 shadow-md mx-auto"
                                style="max-width: 500px;">
                                <video id="video-login" class="block bg-black"></video>
                                <canvas id="canvas-login" class="block"></canvas>
                            </div>
                            <button id="login-btn"
                                class="w-full px-8 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition transform hover:scale-105 shadow-lg"
                                disabled>Recognize Face & Verify Location</button>
                            <button onclick="goHome()"
                                class="mt-4 text-sm text-blue-400 hover:text-blue-300 transition duration-200">&larr;
                                Back to
                                Home</button>
                        </div>

                        <!-- Batch Selection Screen (after registration) -->
                        <div id="batch-selection-screen" class="hidden bg-gray-800 p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-semibold text-center mb-6">Select Your Batch</h2>
                            <p class="text-center text-gray-400 mb-6">Please select the batch you belong to. This will determine your timetable.</p>
                            
                            <div class="space-y-4">
                                <label class="block text-sm font-medium text-gray-400 mb-2">Available Batches</label>
                                <select id="student-batch-select" 
                                    class="w-full p-3 rounded-lg border border-gray-600 bg-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">-- Select a Batch --</option>
                                </select>
                                
                                <div id="batch-selection-message" class="text-sm text-gray-500 mt-2"></div>
                                
                                <button id="confirm-batch-btn"
                                    class="w-full px-8 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition transform hover:scale-105 shadow-lg disabled:bg-gray-600 disabled:cursor-not-allowed"
                                    disabled>Confirm and Continue</button>
                            </div>
                            
                            <button onclick="goHome()"
                                class="mt-4 text-sm text-blue-400 hover:text-blue-300 transition duration-200">&larr;
                                Back to Home</button>
                        </div>

                        <!-- Loading -->
                        <div id="loading" class="hidden text-center bg-gray-800 p-6 rounded-lg shadow-md">
                            <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <p class="mt-4 text-gray-400">Loading face models...</p>
                        </div>
                    </div>

                    <!-- Dashboard Content (Initially Hidden) -->
                    <div id="dashboard-content" class="hidden">
                        <!-- Welcome Dashboard Tab -->
                        <div id="dashboard" class="tab-content active">
                            <div class="space-y-6">
                                <!-- Welcome Header -->
                                <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 rounded-lg shadow-lg">
                                    <div class="flex flex-col md:flex-row items-center justify-between">
                                        <div class="text-white mb-4 md:mb-0">
                                            <h1 class="text-3xl font-bold mb-2">Welcome back, <span id="dashboard-username">User</span>!</h1>
                                            <p class="text-blue-100">Here's what's happening today</p>
                                        </div>
                                        <div class="text-right text-white">
                                            <p class="text-sm text-blue-100" id="dashboard-date"></p>
                                            <p class="text-2xl font-bold" id="dashboard-time"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stats Cards -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-gray-400 text-sm">Today's Attendance</p>
                                                <p class="text-2xl font-bold text-white mt-1" id="attendance-count">0/0</p>
                                            </div>
                                            <div class="bg-blue-900 p-3 rounded-full">
                                                <i class="fas fa-fingerprint text-blue-400 text-2xl"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-green-500">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-gray-400 text-sm">Upcoming Classes</p>
                                                <p class="text-2xl font-bold text-white mt-1" id="upcoming-classes">0</p>
                                            </div>
                                            <div class="bg-green-900 p-3 rounded-full">
                                                <i class="fas fa-calendar-check text-green-400 text-2xl"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-yellow-500">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-gray-400 text-sm">This Week</p>
                                                <p class="text-2xl font-bold text-white mt-1" id="week-attendance">0%</p>
                                            </div>
                                            <div class="bg-yellow-900 p-3 rounded-full">
                                                <i class="fas fa-chart-line text-yellow-400 text-2xl"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-purple-500">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-gray-400 text-sm">Total Classes</p>
                                                <p class="text-2xl font-bold text-white mt-1" id="total-classes">0</p>
                                            </div>
                                            <div class="bg-purple-900 p-3 rounded-full">
                                                <i class="fas fa-book text-purple-400 text-2xl"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Actions & Today's Schedule -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <!-- Quick Actions -->
                                    <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                                        <h2 class="text-xl font-bold mb-4 flex items-center">
                                            <i class="fas fa-bolt text-yellow-400 mr-2"></i>
                                            Quick Actions
                                        </h2>
                                        <div class="grid grid-cols-2 gap-4">
                                            <button onclick="switchTab('attendance')" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg transition transform hover:scale-105 flex flex-col items-center">
                                                <i class="fas fa-fingerprint text-2xl mb-2"></i>
                                                <span class="font-semibold">Mark Attendance</span>
                                            </button>
                                            <button onclick="switchTab('timetable')" class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg transition transform hover:scale-105 flex flex-col items-center">
                                                <i class="fas fa-calendar-alt text-2xl mb-2"></i>
                                                <span class="font-semibold">View Timetable</span>
                                            </button>
                                            <button onclick="switchTab('suggestions')" class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg transition transform hover:scale-105 flex flex-col items-center">
                                                <i class="fas fa-lightbulb text-2xl mb-2"></i>
                                                <span class="font-semibold">Suggestions</span>
                                            </button>
                                            <button onclick="switchTab('profile')" class="bg-gray-700 hover:bg-gray-600 text-white p-4 rounded-lg transition transform hover:scale-105 flex flex-col items-center">
                                                <i class="fas fa-user text-2xl mb-2"></i>
                                                <span class="font-semibold">My Profile</span>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Today's Schedule -->
                                    <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                                        <h2 class="text-xl font-bold mb-4 flex items-center">
                                            <i class="fas fa-clock text-blue-400 mr-2"></i>
                                            Today's Schedule
                                        </h2>
                                        <div class="space-y-3" id="dashboard-schedule">
                                            <div class="flex items-center p-3 bg-gray-700 rounded-lg">
                                                <div class="bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded mr-3">9:00</div>
                                                <div class="flex-1">
                                                    <div class="font-medium text-white">Data Structures</div>
                                                    <div class="text-xs text-gray-400">Room 302 ‚Ä¢ Prof. Sharma</div>
                                                </div>
                                                <span class="bg-green-800 text-green-200 text-xs px-2 py-1 rounded-full">Completed</span>
                                            </div>
                                            <div class="flex items-center p-3 bg-gray-700 rounded-lg">
                                                <div class="bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded mr-3">10:00</div>
                                                <div class="flex-1">
                                                    <div class="font-medium text-white">Algorithms</div>
                                                    <div class="text-xs text-gray-400">Room 305 ‚Ä¢ Prof. Gupta</div>
                                                </div>
                                                <span class="bg-yellow-800 text-yellow-200 text-xs px-2 py-1 rounded-full">In Progress</span>
                                            </div>
                                            <div class="flex items-center p-3 bg-gray-700 rounded-lg">
                                                <div class="bg-green-600 text-white text-xs font-bold px-3 py-1 rounded mr-3">11:00</div>
                                                <div class="flex-1">
                                                    <div class="font-medium text-white">Free Period</div>
                                                    <div class="text-xs text-gray-400">Library ‚Ä¢ Self Study</div>
                                                </div>
                                                <span class="bg-blue-800 text-blue-200 text-xs px-2 py-1 rounded-full">Upcoming</span>
                                            </div>
                                        </div>
                                        <button onclick="switchTab('timetable')" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition">
                                            View Full Timetable ‚Üí
                                        </button>
                                    </div>
                                </div>

                                <!-- Recent Activity -->
                                <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                                    <h2 class="text-xl font-bold mb-4 flex items-center">
                                        <i class="fas fa-history text-green-400 mr-2"></i>
                                        Recent Activity
                                    </h2>
                                    <div class="space-y-3" id="recent-activity">
                                        <div class="flex items-center p-3 bg-gray-700 rounded-lg">
                                            <div class="bg-green-600 p-2 rounded-full mr-3">
                                                <i class="fas fa-check text-white"></i>
                                            </div>
                                            <div class="flex-1">
                                                <div class="font-medium text-white">Attendance marked</div>
                                                <div class="text-xs text-gray-400">Data Structures ‚Ä¢ 9:00 AM</div>
                                            </div>
                                            <div class="text-xs text-gray-400">2 hours ago</div>
                                        </div>
                                        <div class="flex items-center p-3 bg-gray-700 rounded-lg">
                                            <div class="bg-blue-600 p-2 rounded-full mr-3">
                                                <i class="fas fa-calendar text-white"></i>
                                            </div>
                                            <div class="flex-1">
                                                <div class="font-medium text-white">Timetable updated</div>
                                                <div class="text-xs text-gray-400">Weekly schedule modified</div>
                                            </div>
                                            <div class="text-xs text-gray-400">1 day ago</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Attendance Tab -->
                        <div id="attendance" class="tab-content">
                            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                                <h2 class="text-2xl font-bold mb-4">Mark Attendance</h2>
                                <div class="camera-container rounded-3xl overflow-hidden mb-6 shadow-md mx-auto"
                                    style="max-width: 500px;">
                                    <video id="video-attendance" class="block bg-black"></video>
                                    <canvas id="canvas-attendance" class="block"></canvas>
                                </div>
                                <div id="liveness-status" class="mb-2 text-center text-sm text-gray-400" style="display: none;">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>
                                    <span id="liveness-status-text">Verifying you are live...</span>
                                </div>
                                <button id="mark-attendance-btn"
                                    class="w-full px-8 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition transform hover:scale-105 shadow-lg"
                                    disabled>
                                    <span id="mark-attendance-btn-text">Mark Attendance with Face Recognition</span>
                                </button>
                                <div class="mt-8">
                                    <h3 class="text-xl font-semibold mb-4">Today's Attendance</h3>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full bg-gray-700 rounded-lg">
                                            <thead>
                                                <tr>
                                                    <th class="py-2 px-4 border-b border-gray-600">Class</th>
                                                    <th class="py-2 px-4 border-b border-gray-600">Time</th>
                                                    <th class="py-2 px-4 border-b border-gray-600">Method</th>
                                                    <th class="py-2 px-4 border-b border-gray-600">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td class="py-2 px-4 border-b border-gray-600">Data Structures</td>
                                                    <td class="py-2 px-4 border-b border-gray-600">9:00 AM</td>
                                                    <td class="py-2 px-4 border-b border-gray-600">Face</td>
                                                    <td class="py-2 px-4 border-b border-gray-600">
                                                        <span
                                                            class="px-2 py-1 rounded-full text-xs bg-green-800 text-green-200">Present</span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="py-2 px-4 border-b border-gray-600">Algorithms</td>
                                                    <td class="py-2 px-4 border-b border-gray-600">10:00 AM</td>
                                                    <td class="py-2 px-4 border-b border-gray-600">-</td>
                                                    <td class="py-2 px-4 border-b border-gray-600">
                                                        <span
                                                            class="px-2 py-1 rounded-full text-xs bg-yellow-800 text-yellow-200">Pending</span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Timetable Tab -->
                        <div id="timetable" class="tab-content">
                            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-bold">Weekly Timetable</h2>
                                    <div id="timetable-batch-info" class="text-sm text-gray-400">
                                        <!-- Batch name will be displayed here -->
                                    </div>
                                </div>

                                <div class="mb-6 flex justify-between items-center">
                                    <div class="flex space-x-2">
                                        <button class="bg-blue-700 text-white px-3 py-1 rounded"
                                            onclick="changeDay('Mon')">Mon</button>
                                        <button class="bg-gray-700 text-gray-300 px-3 py-1 rounded"
                                            onclick="changeDay('Tue')">Tue</button>
                                        <button class="bg-gray-700 text-gray-300 px-3 py-1 rounded"
                                            onclick="changeDay('Wed')">Wed</button>
                                        <button class="bg-gray-700 text-gray-300 px-3 py-1 rounded"
                                            onclick="changeDay('Thu')">Thu</button>
                                        <button class="bg-gray-700 text-gray-300 px-3 py-1 rounded"
                                            onclick="changeDay('Fri')">Fri</button>
                                    </div>
                                    <div class="text-blue-400 font-medium">
                                        <div id="currentDate">Monday, 29 September 2025</div>
                                        <div id="currentTime" class="text-lg font-bold mt-1">00:00:00</div>
                                    </div>
                                </div>

                                <div class="mb-4 flex justify-end gap-2">
                                    <button id="exportTimetablePDF" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                                        <i class="fas fa-file-pdf"></i> Export PDF
                                    </button>
                                    <button id="addTimetableEntry" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                                        <i class="fas fa-plus"></i> Add Entry
                                    </button>
                                </div>
                                <div class="space-y-4" id="timetableContent">
                                    <!-- Timetable entries will be dynamically generated here -->
                                        </div>
                            </div>
                        </div>

                        <!-- Rescheduler Tab -->
                        <div id="rescheduler" class="tab-content">
                            <div class="panel">
                                <div class="flex-between">
                                    <div>
                                        <strong>Step 1 ‚Äî Setup</strong>
                                        <div style="color:var(--muted); font-size:13px; margin-top:6px">Add classes and
                                            subjects. Each subject needs a teacher and class average for that subject.
                                        </div>
                                    </div>
                                    <div style="display:flex;gap:8px">
                                        <button class="btn" id="addClassBtn">+ Add Class</button>
                                        <button class="btn ghost" id="resetBtn">Reset All</button>
                                    </div>
                                </div>

                                <div class="classes" id="classesContainer"></div>

                                <hr
                                    style="border:none; height:1px; margin:14px 0; background:linear-gradient(90deg, transparent, rgba(124,77,255,0.06), transparent)">

                                <div style="margin-top:8px">
                                    <div class="row">
                                        <label class="small">Number of periods (per day)</label>
                                        <input id="periodCount" class="input" type="number" min="1" value="6" />
                                        <label class="small">(Name your periods optional - left blank uses
                                            P1,P2...)</label>
                                    </div>

                                    <div class="row" style="margin-top:10px">
                                        <label class="small">Create Timetable for each class (use the subject names you
                                            added, comma separated per period)</label>
                                        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px"
                                            id="timetablesInputs"></div>
                                    </div>
                                </div>

                                <hr
                                    style="border:none; height:1px; margin:14px 0; background:linear-gradient(90deg, transparent, rgba(124,77,255,0.06), transparent)">

                                <div>
                                    <strong>Step 2 ‚Äî Absent Teacher(s)</strong>
                                    <div style="color:var(--muted); font-size:13px; margin-top:6px">Select which
                                        teacher(s) are absent today. You can add multiple absent teachers.</div>

                                    <div class="absent-list" id="absentList"></div>
                                    <div style="margin-top:10px">
                                        <select id="absentTeacherSelect" class="input"></select>
                                        <button class="btn" id="addAbsentBtn" style="margin-left:8px">+ Add
                                            Absent</button>
                                    </div>
                                </div>

                                <hr
                                    style="border:none; height:1px; margin:14px 0; background:linear-gradient(90deg, transparent, rgba(124,77,255,0.06), transparent)">

                                <div class="flex-between" style="margin-top:8px">
                                    <div style="color:var(--muted)">Preview timetable & teacher assignment below
                                        (editable)</div>
                                    <div>
                                        <button class="btn warn" id="previewBtn">Preview Timetable</button>
                                        <button class="btn" id="regenBtn">Regenerate Schedule ‚Üí</button>
                                    </div>
                                </div>

                                <div class="timetable" id="previewArea" style="display:none; margin-top:12px"></div>
                            </div>

                            <!-- Result View -->
                            <div id="resultView" class="panel" style="display:none; margin-top: 20px;">
                                <div class="result-title">
                                    <div>
                                        <strong>Regenerated Day Timetable</strong>
                                        <div style="color:var(--muted); font-size:13px; margin-top:6px">Rules applied:
                                            absent teachers removed ‚Üí available teachers reassigned per-period ‚Üí one
                                            teacher per period ‚Üí most needy class gets priority</div>
                                    </div>
                                    <div>
                                        <span class="badge" id="absentBadge">Absent: 0</span>
                                    </div>
                                </div>

                                <div style="margin-top:12px" id="resultTablesContainer"></div>

                                <div style="margin-top:14px; display:flex; gap:10px">
                                    <button class="btn ghost" id="backBtn">‚Üê Back & Edit</button>
                                    <button class="btn" id="downloadBtn">Download CSV</button>
                                </div>
                            </div>
                        </div>

                        <!-- Suggestions Tab -->
                        <div id="suggestions" class="tab-content">
                            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                                <h2 class="text-2xl font-bold mb-4">Free Time Suggestions</h2>
                                <p class="text-gray-400 mb-6">Based on your interests in <span class="font-semibold">Web
                                        Development, Machine Learning, and Data Structures</span></p>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="border border-gray-700 rounded-lg p-4 hover:shadow-md transition">
                                        <div class="flex items-start mb-3">
                                            <div class="bg-blue-900 p-2 rounded-lg mr-4">
                                                <i class="fas fa-code text-blue-400 text-xl"></i>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold">Practice JavaScript Algorithms</h3>
                                                <p class="text-sm text-gray-400">15-20 minutes</p>
                                            </div>
                                        </div>
                                        <p class="text-gray-300 mb-4">Solve 2-3 algorithm challenges to improve your
                                            problem-solving skills.</p>
                                        <div class="flex justify-between items-center">
                                            <span
                                                class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded">Coding</span>
                                            <button
                                                class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded"
                                                onclick="startSuggestion('algorithms')">Start Now</button>
                                        </div>
                                    </div>

                                    <div class="border border-gray-700 rounded-lg p-4 hover:shadow-md transition">
                                        <div class="flex items-start mb-3">
                                            <div class="bg-purple-900 p-2 rounded-lg mr-4">
                                                <i class="fas fa-brain text-purple-400 text-xl"></i>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold">Read ML Research Paper</h3>
                                                <p class="text-sm text-gray-400">25-30 minutes</p>
                                            </div>
                                        </div>
                                        <p class="text-gray-300 mb-4">Read a summary of recent advances in transformer
                                            models.</p>
                                        <div class="flex justify-between items-center">
                                            <span class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded">Machine
                                                Learning</span>
                                            <button
                                                class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded"
                                                onclick="startSuggestion('ml')">Start Now</button>
                                        </div>
                                    </div>

                                    <div class="border border-gray-700 rounded-lg p-4 hover:shadow-md transition">
                                        <div class="flex items-start mb-3">
                                            <div class="bg-green-900 p-2 rounded-lg mr-4">
                                                <i class="fas fa-book text-green-400 text-xl"></i>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold">Review Data Structures</h3>
                                                <p class="text-sm text-gray-400">20-25 minutes</p>
                                            </div>
                                        </div>
                                        <p class="text-gray-300 mb-4">Revise tree traversal algorithms and practice
                                            implementation.</p>
                                        <div class="flex justify-between items-center">
                                            <span
                                                class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded">Study</span>
                                            <button
                                                class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded"
                                                onclick="startSuggestion('ds')">Start Now</button>
                                        </div>
                                    </div>

                                    <div class="border border-gray-700 rounded-lg p-4 hover:shadow-md transition">
                                        <div class="flex items-start mb-3">
                                            <div class="bg-yellow-900 p-2 rounded-lg mr-4">
                                                <i class="fas fa-tasks text-yellow-400 text-xl"></i>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold">Plan Your Project</h3>
                                                <p class="text-sm text-gray-400">10-15 minutes</p>
                                            </div>
                                        </div>
                                        <p class="text-gray-300 mb-4">Outline the next steps for your web development
                                            project.</p>
                                        <div class="flex justify-between items-center">
                                            <span
                                                class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded">Planning</span>
                                            <button
                                                class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded"
                                                onclick="startSuggestion('project')">Start Now</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Profile Tab -->
                        <div id="profile" class="tab-content">
                            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                                <h2 class="text-2xl font-bold mb-6">Student Profile</h2>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                    <div class="md:col-span-1 flex flex-col items-center">
                                        <img id="profile-photo" class="h-32 w-32 rounded-full mb-4 border-4 border-blue-500 object-cover cursor-pointer"
                                            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366F1'%3E%3Cpath d='M12 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0 2c-6.627 0-12 5.373-12 12h24c0-6.627-5.373-12-12-12z'/%3E%3C/svg%3E"
                                            alt="Profile">
                                        <input type="file" id="profile-photo-input" accept="image/*" style="display: none;">
                                        <button id="change-photo-btn" class="text-blue-400 text-sm mt-2 hover:text-blue-300 cursor-pointer">Change Photo</button>
                                    </div>

                                    <div class="md:col-span-2">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-400 mb-1">Full
                                                    Name</label>
                                                <input type="text" id="profile-name" value="enter your name"
                                                    class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-400 mb-1">College
                                                    ID</label>
                                                <input type="text" id="profile-id" value="enter your batch"
                                                    class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-medium text-gray-400 mb-1">Email</label>
                                                <input type="email" id="profile-email" value="enter your mail"
                                                    class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-medium text-gray-400 mb-1">Course</label>
                                                <input type="text" id="profile-course" value="enter your course"
                                                    class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <h3 class="text-lg font-semibold mb-3">Interests & Skills</h3>
                                    <div class="flex flex-wrap gap-2 mb-3" id="skills-container">
                                        <!-- Skills will be dynamically added here -->
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="new-skill-input" 
                                            placeholder="Enter a skill or interest"
                                            class="flex-1 px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <button id="add-skill-btn" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                                            <i class="fas fa-plus mr-2"></i>Add Skill
                                        </button>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <h3 class="text-lg font-semibold mb-3">Career Goals</h3>
                                    <textarea id="profile-goals"
                                        class="w-full px-4 py-2 border border-gray-600 rounded-lg h-24 bg-gray-700 text-white">I want to become a full-stack developer with expertise in React and Node.js, and eventually move into AI engineering.</textarea>
                                </div>

                                <div class="flex justify-end">
                                    <button id="saveProfileBtn"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">Save
                                        Changes</button>
                                </div>
                            </div>
                        </div>

                        <!-- Routine Tab -->
                        <div id="routine" class="tab-content">
                            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                                <h2 class="text-2xl font-bold mb-6">Daily Routine</h2>

                                <div class="mb-6 flex justify-between items-center">
                                    <div class="text-lg font-semibold">Monday, 29 September 2025</div>
                                    <button id="exportRoutineBtn"
                                        class="bg-blue-900 text-blue-200 px-4 py-2 rounded-lg">
                                        <i class="fas fa-download mr-2"></i>Export Routine
                                    </button>
                                </div>

                                <div class="space-y-4">
                                    <div class="flex items-center p-4 bg-blue-900 rounded-lg">
                                        <div class="w-16 text-blue-200 font-bold">7:00</div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold">Morning Routine</h3>
                                            <p class="text-sm text-gray-400">Exercise, Breakfast</p>
                                        </div>
                                        <div class="bg-green-800 text-green-200 text-xs px-2 py-1 rounded-full">
                                            Completed</div>
                                    </div>

                                    <div class="flex items-center p-4 bg-blue-900 rounded-lg">
                                        <div class="w-16 text-blue-200 font-bold">9:00</div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold">Data Structures Class</h3>
                                            <p class="text-sm text-gray-400">Room 302</p>
                                        </div>
                                        <div class="bg-green-800 text-green-200 text-xs px-2 py-1 rounded-full">
                                            Completed</div>
                                    </div>

                                    <div class="flex items-center p-4 bg-blue-900 rounded-lg">
                                        <div class="w-16 text-blue-200 font-bold">10:00</div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold">Algorithms Class</h3>
                                            <p class="text-sm text-gray-400">Room 305</p>
                                        </div>
                                        <div class="bg-yellow-800 text-yellow-200 text-xs px-2 py-1 rounded-full">In
                                            Progress</div>
                                    </div>

                                    <div class="flex items-center p-4 bg-green-900 rounded-lg">
                                        <div class="w-16 text-green-200 font-bold">11:00</div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold">Free Period - Suggested Activity</h3>
                                            <p class="text-sm text-gray-400">Practice JavaScript Algorithms (15 min)</p>
                                        </div>
                                        <div class="bg-blue-800 text-blue-200 text-xs px-2 py-1 rounded-full">Upcoming
                                        </div>
                                    </div>

                                    <div class="flex items-center p-4 bg-gray-700 rounded-lg">
                                        <div class="w-16 text-gray-300 font-bold">12:00</div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold">Lunch Break</h3>
                                            <p class="text-sm text-gray-400">Cafeteria</p>
                                        </div>
                                    </div>

                                    <div class="flex items-center p-4 bg-blue-900 rounded-lg">
                                        <div class="w-16 text-blue-200 font-bold">14:00</div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold">Database Systems Class</h3>
                                            <p class="text-sm text-gray-400">Room 401</p>
                                        </div>
                                        <div class="bg-gray-600 text-gray-300 text-xs px-2 py-1 rounded-full">Not
                                            Started</div>
                                    </div>

                                    <div class="flex items-center p-4 bg-green-900 rounded-lg">
                                        <div class="w-16 text-green-200 font-bold">16:00</div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold">Free Time - Suggested Activity</h3>
                                            <p class="text-sm text-gray-400">Read ML Research Paper (25 min)</p>
                                        </div>
                                        <div class="bg-gray-600 text-gray-300 text-xs px-2 py-1 rounded-full">Not
                                            Started</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher Dashboard (Hidden Initially) -->
    <div id="teacher-dashboard" class="hidden min-h-screen bg-gray-900">
        <nav class="bg-green-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-chalkboard-teacher text-2xl"></i>
                    <span class="text-xl font-bold">SmartClass - Teacher</span>
                </div>
                <button class="bg-green-700 hover:bg-green-800 px-4 py-2 rounded-lg transition"
                    onclick="logout()">Logout</button>
            </div>
        </nav>
        <div class="container mx-auto px-4 py-6">
            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                <h1 class="text-3xl font-bold mb-6">Teacher Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-green-900 p-4 rounded-lg">
                        <h2 class="text-xl font-semibold mb-4">Mark Attendance</h2>
                        <button id="start-attendance-btn"
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded transition">Start
                            Attendance Session</button>
                    </div>
                    <div class="bg-green-900 p-4 rounded-lg">
                        <h2 class="text-xl font-semibold mb-4">View Class Timetable</h2>
                        <button id="load-timetable-btn"
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded transition">Load
                            Timetable</button>
                    </div>
                </div>
                <div class="mt-6 bg-green-900 p-4 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">Reschedule Classes</h2>
                    <p class="text-gray-300">Manage absent teachers and regenerate schedules.</p>
                    <button id="open-rescheduler-btn"
                        class="mt-4 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition">Open
                        Rescheduler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard (Hidden Initially) -->
    <div id="admin-dashboard" class="hidden min-h-screen bg-gray-900">
        <nav class="bg-purple-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-user-shield text-2xl"></i>
                    <span class="text-xl font-bold">SmartClass - Admin</span>
                </div>
                <button class="bg-purple-700 hover:bg-purple-800 px-4 py-2 rounded-lg transition"
                    onclick="logout()">Logout</button>
            </div>
        </nav>
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Admin Panel</h1>
                <button id="create-batch-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition flex items-center gap-2">
                    <i class="fas fa-plus"></i> Create Batch
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- User Management Section -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">User Management</h2>
                        <button class="minimize-section-btn text-gray-400 hover:text-white transition" data-section="user-management">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    <div id="user-management-content">
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Select User Type</label>
                        <select id="user-type-select" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            <option value="">-- Select Type --</option>
                            <option value="student">Student</option>
                            <option value="teacher">Teacher</option>
                        </select>
                    </div>

                    <div class="mb-4" id="email-input-container" style="display: none;">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Email Address</label>
                        <input type="email" id="user-email-input" 
                            placeholder="Enter email address"
                            class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>

                    <button id="add-user-btn" 
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg transition mb-4"
                        disabled>
                        <i class="fas fa-user-plus mr-2"></i>Add User
                    </button>

                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-3">Registered Users</h3>
                        <div class="space-y-2 max-h-64 overflow-y-auto" id="users-list">
                            <!-- Users will be displayed here -->
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Batch Management Section -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">Batch Management</h2>
                        <button class="minimize-section-btn text-gray-400 hover:text-white transition" data-section="batch-management">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    <div id="batch-management-content">
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Select Batch</label>
                        <div class="flex gap-2 mb-2">
                            <select id="batch-select" class="flex-1 px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                <option value="">-- Select or Create Batch --</option>
                            </select>
                            <button id="new-batch-name-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <input type="text" id="new-batch-name-input" 
                            placeholder="Enter batch name (e.g., CS2021)"
                            class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 mb-2"
                            style="display: none;">
                    </div>

                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-3">Select Students</h3>
                        <div class="max-h-48 overflow-y-auto border border-gray-600 rounded-lg p-3 bg-gray-700" id="students-checkbox-list">
                            <!-- Student checkboxes will be displayed here -->
                        </div>
                    </div>

                    <div class="mb-4">
                        <h3 class="text-sm font-medium text-gray-400 mb-2">Selected Students</h3>
                        <div class="min-h-16 max-h-32 overflow-y-auto border border-gray-600 rounded-lg p-3 bg-gray-700 flex flex-wrap gap-2" id="selected-students">
                            <span class="text-gray-500 text-sm">No students selected</span>
                        </div>
                    </div>

                    <button id="add-to-batch-btn" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition mb-4"
                        disabled>
                        <i class="fas fa-users mr-2"></i>Add Selected to Batch
                    </button>

                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-3">Existing Batches</h3>
                        <div class="space-y-2 max-h-64 overflow-y-auto" id="batches-list">
                            <!-- Batches will be displayed here -->
                        </div>
                    </div>
                    </div>
                </div>
            </div>

            <!-- Timetable Management Section -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-md mt-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Timetable Management</h2>
                    <button class="minimize-section-btn text-gray-400 hover:text-white transition" data-section="timetable-management">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                <div id="timetable-management-content">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-400 mb-2">Select Batch for Timetable</label>
                    <select id="timetable-batch-select" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        <option value="">-- Select Batch --</option>
                    </select>
                </div>

                <div id="timetable-management-container" class="hidden">
                    <div class="mb-4 flex gap-2">
                        <button id="add-timetable-row" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                            <i class="fas fa-plus mr-2"></i>Add Time Slot
                        </button>
                        <button id="save-timetable" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                            <i class="fas fa-save mr-2"></i>Save Weekly Timetable
                        </button>
                    </div>

                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-300">Weekly Timetable Grid</h3>
                        <p class="text-sm text-gray-400">Manage the complete week's timetable for this batch</p>
                    </div>

                    <div class="overflow-x-auto">
                        <table id="timetable-grid" class="w-full border-collapse border border-gray-600 bg-gray-700">
                            <thead id="timetable-header">
                                <tr>
                                    <th class="border border-gray-600 p-3 bg-gray-800 text-gray-300 font-semibold sticky left-0 z-10">Time</th>
                                    <th class="border border-gray-600 p-3 bg-gray-800 text-gray-300 font-semibold min-w-[200px]">Monday</th>
                                    <th class="border border-gray-600 p-3 bg-gray-800 text-gray-300 font-semibold min-w-[200px]">Tuesday</th>
                                    <th class="border border-gray-600 p-3 bg-gray-800 text-gray-300 font-semibold min-w-[200px]">Wednesday</th>
                                    <th class="border border-gray-600 p-3 bg-gray-800 text-gray-300 font-semibold min-w-[200px]">Thursday</th>
                                    <th class="border border-gray-600 p-3 bg-gray-800 text-gray-300 font-semibold min-w-[200px]">Friday</th>
                                    <th class="border border-gray-600 p-3 bg-gray-800 text-gray-300 font-semibold">Action</th>
                                </tr>
                            </thead>
                            <tbody id="timetable-body">
                                <!-- Weekly grid rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
            </div>

            <!-- Other Admin Features -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="bg-purple-900 p-4 rounded-lg">
                        <h2 class="text-xl font-semibold mb-4">Attendance Reports</h2>
                        <button id="generate-report-btn"
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded transition">Generate
                            Report</button>
                    </div>
                    <div class="bg-purple-900 p-4 rounded-lg">
                        <h2 class="text-xl font-semibold mb-4">System Settings</h2>
                        <button id="edit-settings-btn"
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded transition">Edit
                            Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-900 p-8 rounded-2xl shadow-xl max-w-sm w-full text-center space-y-4 border border-gray-700">
            <p id="message-text" class="text-lg text-white"></p>
            <button onclick="hideMessage()"
                class="px-6 py-2 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition duration-200">OK</button>
        </div>
    </div>

    <script>
        let currentRole = null;

        // Role Selection
        function selectRole(role) {
            currentRole = role;
            document.getElementById('role-selection').classList.add('hidden');
            const dashboard = document.getElementById(role + '-dashboard');
            if (dashboard) {
                dashboard.classList.remove('hidden');
                if (role === 'student') {
                    // Initialize student-specific JS
                    initializeStudentDashboard();
                } else if (role === 'teacher') {
                    initializeTeacherDashboard();
                } else if (role === 'admin') {
                    initializeAdminDashboard();
                }
            }
        }

        function logout() {
            currentRole = null;
            document.getElementById('role-selection').classList.remove('hidden');
            document.getElementById('student-dashboard').classList.add('hidden');
            document.getElementById('teacher-dashboard').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
            // Reset student state if active
            if (typeof stopAllVideo === 'function') stopAllVideo();
        }

        // Student Dashboard Initialization
        function initializeStudentDashboard() {
            // ===== Face Recognition System =====
            const videoReg = document.getElementById('video-reg');
            const videoLogin = document.getElementById('video-login');
            const canvasReg = document.getElementById('canvas-reg');
            const canvasLogin = document.getElementById('canvas-login');
            const registerBtn = document.getElementById('register-btn');
            const loginBtn = document.getElementById('login-btn');
            const usernameInput = document.getElementById('username-input');
            const videoAttendance = document.getElementById('video-attendance');
            const canvasAttendance = document.getElementById('canvas-attendance');
            const markAttendanceBtn = document.getElementById('mark-attendance-btn');

            const homeScreen = document.getElementById('home-screen');
            const registerScreen = document.getElementById('register-screen');
            const loginScreen = document.getElementById('login-screen');
            const loading = document.getElementById('loading');
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            const authScreens = document.getElementById('auth-screens');
            const dashboardContent = document.getElementById('dashboard-content');

            let isVideoRegPlaying = false;
            let isVideoLoginPlaying = false;
            let isVideoAttendancePlaying = false;
            let regInterval, loginInterval, attendanceInterval;
            let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers')) || {};
            let loggedInUser = null;

            // Classroom location
            const CLASSROOM_LOCATION = { lat: 22.681432, lon: 75.879018 };
            const RADIUS_METERS = 49;

            // Function to update all profile photos (defined early for use in login)
            function updateAllProfilePhotos(imageData) {
                const profilePhoto = document.getElementById('profile-photo');
                const navProfilePhoto = document.getElementById('nav-profile-photo');
                const sidebarProfilePhoto = document.getElementById('sidebar-profile-photo');
                
                if (profilePhoto && imageData) {
                    profilePhoto.src = imageData;
                }
                if (navProfilePhoto && imageData) {
                    navProfilePhoto.src = imageData;
                }
                if (sidebarProfilePhoto && imageData) {
                    sidebarProfilePhoto.src = imageData;
                }
            }

            // Utility functions
            const showMessage = (msg) => { 
                if (messageText) messageText.textContent = msg; 
                if (messageBox) messageBox.classList.remove('hidden'); 
            };
            const hideMessage = () => { 
                if (messageBox) messageBox.classList.add('hidden'); 
            };
            const goHome = () => {
                stopAllVideo();
                if (homeScreen) homeScreen.classList.remove('hidden');
                if (registerScreen) registerScreen.classList.add('hidden');
                if (loginScreen) loginScreen.classList.add('hidden');
                const batchSelectionScreen = document.getElementById('batch-selection-screen');
                if (batchSelectionScreen) batchSelectionScreen.classList.add('hidden');
            };
            
            // Show batch selection screen
            function showBatchSelection() {
                stopAllVideo();
                const registerScreen = document.getElementById('register-screen');
                const batchSelectionScreen = document.getElementById('batch-selection-screen');
                const homeScreen = document.getElementById('home-screen');
                
                if (registerScreen) registerScreen.classList.add('hidden');
                if (homeScreen) homeScreen.classList.add('hidden');
                if (batchSelectionScreen) {
                    batchSelectionScreen.classList.remove('hidden');
                    loadBatchesForSelection();
                }
            }
            
            // Load batches for student selection
            function loadBatchesForSelection() {
                const batchSelect = document.getElementById('student-batch-select');
                const confirmBtn = document.getElementById('confirm-batch-btn');
                const messageEl = document.getElementById('batch-selection-message');
                
                if (!batchSelect) return;
                
                try {
                    const batches = JSON.parse(localStorage.getItem('adminBatches') || '{}');
                    const batchNames = Object.keys(batches).filter(name => name && name.trim() !== '');
                    
                    batchSelect.innerHTML = '<option value="">-- Select a Batch --</option>';
                    
                    if (batchNames.length === 0) {
                        batchSelect.innerHTML += '<option value="" disabled>No batches available. Please contact admin.</option>';
                        if (messageEl) messageEl.textContent = 'No batches have been created yet. Please contact your administrator.';
                        if (confirmBtn) confirmBtn.disabled = true;
                    } else {
                        batchNames.forEach(batchName => {
                            const option = document.createElement('option');
                            option.value = batchName;
                            option.textContent = batchName;
                            batchSelect.appendChild(option);
                        });
                        if (messageEl) messageEl.textContent = `Found ${batchNames.length} batch(es). Please select one.`;
                    }
                } catch (e) {
                    console.error('Error loading batches:', e);
                    batchSelect.innerHTML = '<option value="">Error loading batches</option>';
                    if (messageEl) messageEl.textContent = 'Error loading batches. Please try again.';
                    if (confirmBtn) confirmBtn.disabled = true;
                }
            }
            
            // Handle batch selection change
            const studentBatchSelect = document.getElementById('student-batch-select');
            const confirmBatchBtn = document.getElementById('confirm-batch-btn');
            
            if (studentBatchSelect && confirmBatchBtn) {
                studentBatchSelect.addEventListener('change', function() {
                    confirmBatchBtn.disabled = !this.value || this.value.trim() === '';
                });
                
                confirmBatchBtn.addEventListener('click', function() {
                    const selectedBatch = studentBatchSelect.value;
                    if (!selectedBatch || selectedBatch.trim() === '') {
                        showMessage('Please select a batch.', 'error');
                        return;
                    }
                    
                    try {
                        // Save batch to userProfile
                        const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                        userProfile.batch = selectedBatch;
                        userProfile.id = selectedBatch; // Also save as id for legacy support
                        localStorage.setItem('userProfile', JSON.stringify(userProfile));
                        
                        // Also add username to the batch's email list if not already present
                        const batches = JSON.parse(localStorage.getItem('adminBatches') || '{}');
                        if (batches[selectedBatch] && Array.isArray(batches[selectedBatch])) {
                            const username = userProfile.username || userProfile.name || '';
                            if (username && !batches[selectedBatch].includes(username)) {
                                batches[selectedBatch].push(username);
                                localStorage.setItem('adminBatches', JSON.stringify(batches));
                            }
                        }
                        
                        showMessage(`Batch "${selectedBatch}" selected successfully!`);
                        
                        // Hide batch selection screen
                        const batchSelectionScreen = document.getElementById('batch-selection-screen');
                        if (batchSelectionScreen) batchSelectionScreen.classList.add('hidden');
                        
                        // Show dashboard
                        const authScreens = document.getElementById('auth-screens');
                        const dashboardContent = document.getElementById('dashboard-content');
                        if (authScreens) authScreens.classList.add('hidden');
                        if (dashboardContent) {
                            dashboardContent.classList.remove('hidden');
                            // Initialize dashboard
                            if (typeof initializeDashboard === 'function') {
                                initializeDashboard();
                            }
                            // Initialize timetable to show the selected batch
                            if (typeof initTimetable === 'function') {
                                initTimetable();
                            } else if (typeof renderTimetable === 'function') {
                                // If initTimetable not available, just render
                                renderTimetable('Mon');
                            }
                        }
                    } catch (e) {
                        console.error('Error saving batch selection:', e);
                        showMessage('Error saving batch selection. Please try again.', 'error');
                    }
                });
            }


            window.showRegister = () => {
                if (homeScreen) homeScreen.classList.add('hidden');
                if (registerScreen) registerScreen.classList.remove('hidden');
                startVideo(videoReg, canvasReg, 'register');
            };

            window.showLogin = () => {
                if (homeScreen) homeScreen.classList.add('hidden');
                if (loginScreen) loginScreen.classList.remove('hidden');
                startVideo(videoLogin, canvasLogin, 'login');
            };

            const stopAllVideo = () => {
                [videoReg, videoLogin, videoAttendance].forEach(v => {
                    if (v && v.srcObject) {
                        v.srcObject.getTracks().forEach(t => t.stop());
                        v.pause();
                    }
                });
                if (regInterval) clearInterval(regInterval);
                if (loginInterval) clearInterval(loginInterval);
                if (attendanceInterval) clearInterval(attendanceInterval);
                isVideoRegPlaying = false;
                isVideoLoginPlaying = false;
                isVideoAttendancePlaying = false;
            };

            window.goHome = goHome;
            window.stopAllVideo = stopAllVideo;

            // Haversine distance
            function getDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // metres
                const œÜ1 = lat1 * Math.PI / 180;
                const œÜ2 = lat2 * Math.PI / 180;
                const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
                const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                return R * c; // in metres
            }

            // Load face-api models
            const loadModels = async () => {
                loading.classList.remove('hidden');
                try {
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                        faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                        faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
                    ]);
                    loading.classList.add('hidden');
                    goHome();
                } catch (err) {
                    console.error(err);
                    showMessage("Failed to load face models.");
                    loading.classList.add('hidden');
                }
            };

            // Update canvas size
            function updateCanvasSize(video, canvas) {
                if (!video || !canvas) return;
                canvas.width = video.offsetWidth;
                canvas.height = video.offsetHeight;
                faceapi.matchDimensions(canvas, { width: canvas.width, height: canvas.height });
            }

            // Start camera & detect face
            const startVideo = async (video, canvas, mode) => {
                stopAllVideo();
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        video.play();
                        // Set canvas size after a short delay for rendering
                        setTimeout(() => updateCanvasSize(video, canvas), 200);
                        // Optional: Listen for resize (modern browsers)
                        const resizeObserver = new ResizeObserver(() => updateCanvasSize(video, canvas));
                        resizeObserver.observe(video.parentElement);
                        if (mode === 'register') {
                            isVideoRegPlaying = true;
                            detectFace(video, canvas, mode);
                        } else if (mode === 'login') {
                            isVideoLoginPlaying = true;
                            detectFace(video, canvas, mode);
                        } else if (mode === 'attendance') {
                            isVideoAttendancePlaying = true;
                            detectFace(video, canvas, mode);
                        }
                    };
                } catch (err) {
                    console.error(err);
                    showMessage("Could not access camera.");
                }
            };

            // Detect face
            const detectFace = (video, canvas, mode) => {
                const context = canvas.getContext('2d');
                const interval = setInterval(async () => {
                    let isPlaying;
                    if (mode === 'register') isPlaying = isVideoRegPlaying;
                    else if (mode === 'login') isPlaying = isVideoLoginPlaying;
                    else if (mode === 'attendance') isPlaying = isVideoAttendancePlaying;
                    if (!isPlaying) {
                        clearInterval(interval);
                        return;
                    }
                    if (video.paused || video.ended) {
                        clearInterval(interval);
                        return;
                    }
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 })).withFaceLandmarks().withFaceDescriptor();
                    if (detections) {
                        const resizedDetections = faceapi.resizeResults(detections, { width: canvas.width, height: canvas.height });
                        faceapi.draw.drawDetections(canvas, resizedDetections);
                        faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
                        if (mode === 'register') registerBtn.disabled = false;
                        else if (mode === 'login' && Object.keys(registeredUsers).length > 0) loginBtn.disabled = false;
                        else if (mode === 'attendance' && loggedInUser) markAttendanceBtn.disabled = false;
                    } else if (mode === 'register') {
                        registerBtn.disabled = true;
                    } else if (mode === 'attendance') {
                        markAttendanceBtn.disabled = true;
                    }
                }, 200);
                if (mode === 'register') regInterval = interval;
                else if (mode === 'login') loginInterval = interval;
                else if (mode === 'attendance') attendanceInterval = interval;
            };

            // Handle username input
            usernameInput.addEventListener('input', () => { registerBtn.disabled = usernameInput.value.trim() === ''; });

            // Register button
            registerBtn.addEventListener('click', async () => {
                const username = usernameInput.value.trim();
                if (!username) { showMessage("Enter username."); return; }
                if (registeredUsers[username]) { showMessage("Username exists."); return; }
                const detections = await faceapi.detectSingleFace(videoReg, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 })).withFaceLandmarks().withFaceDescriptor();
                if (detections) {
                    registeredUsers[username] = { descriptor: Array.from(detections.descriptor) };
                    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                    
                    // Save username to userProfile
                    try {
                        const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                        userProfile.username = username;
                        userProfile.name = username;
                        localStorage.setItem('userProfile', JSON.stringify(userProfile));
                    } catch (e) {
                        console.error('Error saving user profile:', e);
                    }
                    
                    showMessage("Registration successful! Please select your batch.");
                    
                    // Show batch selection screen
                    showBatchSelection();
                } else showMessage("Face not detected. Try again.");
            });

            // Login button with location verification
            loginBtn.addEventListener('click', async () => {
                if (Object.keys(registeredUsers).length === 0) { showMessage("No users registered."); return; }
                const detections = await faceapi.detectSingleFace(videoLogin, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 })).withFaceLandmarks().withFaceDescriptor();
                if (!detections) { showMessage("Face not detected."); return; }

                const labeled = await Promise.all(
                    Object.entries(registeredUsers).map(([u, data]) => new faceapi.LabeledFaceDescriptors(u, [new Float32Array(data.descriptor)]))
                );
                const matcher = new faceapi.FaceMatcher(labeled, 0.6);
                const bestMatch = matcher.findBestMatch(detections.descriptor);

                if (bestMatch.distance >= 0.6) { showMessage("Face not recognized."); return; }

                loggedInUser = { username: bestMatch.label, descriptor: new Float32Array(registeredUsers[bestMatch.label].descriptor) };

                // Update UI with username
                const username = bestMatch.label;
                const navUsernameEl = document.getElementById('nav-username');
                const sidebarUsernameEl = document.getElementById('sidebar-username');
                const sidebarIdEl = document.getElementById('sidebar-id');
                
                if (navUsernameEl) navUsernameEl.textContent = username;
                if (sidebarUsernameEl) sidebarUsernameEl.textContent = username;
                if (sidebarIdEl) sidebarIdEl.textContent = username + 'ID';
                
                // Update dashboard username
                const dashboardUsername = document.getElementById('dashboard-username');
                if (dashboardUsername) dashboardUsername.textContent = username;
                
                // Load and update profile photo if available
                try {
                    const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    if (savedProfile.photo) {
                        updateAllProfilePhotos(savedProfile.photo);
                    }
                } catch (e) {
                    console.error('Error loading profile photo on login:', e);
                }

                // Face recognized -> verify location
                if (!navigator.geolocation) { showMessage("Geolocation not supported."); return; }
                navigator.geolocation.getCurrentPosition(pos => {
                    const distance = getDistance(pos.coords.latitude, pos.coords.longitude, CLASSROOM_LOCATION.lat, CLASSROOM_LOCATION.lon);

                    // Show dashboard after successful login
                    if (authScreens) authScreens.classList.add('hidden');
                    if (dashboardContent) dashboardContent.classList.remove('hidden');
                    
                    // Initialize dashboard
                    initializeDashboard();

                    if (distance <= RADIUS_METERS) {
                        showMessage("Location verified ‚úÖ Attendance marked!");
                    } else {
                        showMessage("login successful ‚úÖ, Outside classroom radius ‚ùå Attendance denied.");
                    }
                }, err => {
                    showMessage("Location permission denied.");
                    // Still show dashboard for access
                    authScreens.classList.add('hidden');
                    dashboardContent.classList.remove('hidden');
                    
                    // Initialize dashboard
                    initializeDashboard();
                });
            });

            // Enhanced Liveness Detection Function - Prevents photo/video spoofing
            async function performLivenessCheck(video, duration = 6000) {
                return new Promise(async (resolve) => {
                    // Validate video input
                    if (!video) {
                        resolve({ isLive: false, reason: 'Video stream not available' });
                        return;
                    }

                    // Check if video is actually a live stream (not a static image)
                    if (video.readyState < 2) {
                        resolve({ isLive: false, reason: 'Video stream not ready. Please wait a moment.' });
                        return;
                    }

                    const frames = [];
                    const startTime = Date.now();
                    const checkInterval = 150; // Check every 150ms for more frequent sampling
                    let lastFacePosition = null;
                    let lastFaceSize = null;
                    let movementDistances = []; // Track all movements
                    let sizeVariations = []; // Track face size changes
                    let eyeAspectRatios = [];
                    let blinkCount = 0;
                    let frameCount = 0;
                    const minFrames = 20; // Need at least 20 frames (3 seconds at 150ms intervals)
                    const minMovement = 25; // Minimum pixel movement (increased from 10)
                    const minTotalMovement = 50; // Total movement across all frames
                    const minBlinks = 2; // Require at least 2 blinks
                    const blinkThreshold = 0.25; // EAR below this indicates a blink
                    const normalEAR = 0.30; // Normal open eye EAR
                    let checkLiveness = null;
                    let consecutiveStaticFrames = 0;
                    const maxStaticFrames = 10; // Fail if too many consecutive static frames

                    // Set timeout to ensure cleanup
                    const timeoutId = setTimeout(() => {
                        if (checkLiveness) {
                            clearInterval(checkLiveness);
                            checkLiveness = null;
                        }
                        resolve({ isLive: false, reason: 'Liveness check timed out. Please try again.' });
                    }, duration + 1000); // Add buffer time

                    checkLiveness = setInterval(async () => {
                        if (Date.now() - startTime >= duration) {
                            if (checkLiveness) {
                                clearInterval(checkLiveness);
                                checkLiveness = null;
                            }
                            clearTimeout(timeoutId);
                            
                            // Evaluate liveness with strict criteria
                            if (frameCount < minFrames) {
                                resolve({ isLive: false, reason: 'Not enough frames captured. Please ensure your face is clearly visible.' });
                                return;
                            }

                            // Check for significant movement
                            const totalMovement = movementDistances.reduce((sum, dist) => sum + dist, 0);
                            const maxMovement = Math.max(...movementDistances, 0);
                            
                            if (totalMovement < minTotalMovement || maxMovement < minMovement) {
                                resolve({ isLive: false, reason: 'Insufficient movement detected. Please move your head naturally (possible photo detected).' });
                                return;
                            }

                            // Check for face size variation (zoom in/out indicates live person)
                            if (sizeVariations.length > 0) {
                                const sizeVariance = calculateVariance(sizeVariations);
                                if (sizeVariance < 50) { // Face size should vary
                                    resolve({ isLive: false, reason: 'No size variation detected. Please move closer or farther from camera.' });
                                    return;
                                }
                            }

                            // Check for actual blinks (not just variance)
                            if (eyeAspectRatios.length < 10) {
                                resolve({ isLive: false, reason: 'Insufficient eye data. Please ensure your eyes are clearly visible.' });
                                return;
                            }

                            // Count actual blinks (EAR drops below threshold)
                            blinkCount = 0;
                            let inBlink = false;
                            for (let i = 1; i < eyeAspectRatios.length; i++) {
                                const prevEAR = eyeAspectRatios[i - 1];
                                const currEAR = eyeAspectRatios[i];
                                
                                // Detect blink start (EAR drops below threshold)
                                if (!inBlink && currEAR < blinkThreshold && prevEAR >= blinkThreshold) {
                                    inBlink = true;
                                }
                                // Detect blink end (EAR rises back above threshold)
                                if (inBlink && currEAR >= normalEAR && prevEAR < blinkThreshold) {
                                    blinkCount++;
                                    inBlink = false;
                                }
                            }

                            if (blinkCount < minBlinks) {
                                resolve({ isLive: false, reason: `Only ${blinkCount} blink(s) detected. Please blink naturally at least ${minBlinks} times (possible photo/video detected).` });
                                return;
                            }

                            // Check EAR variance (should have variation)
                            const earVariance = calculateVariance(eyeAspectRatios);
                            if (earVariance < 0.002) {
                                resolve({ isLive: false, reason: 'No eye movement detected. Please blink naturally (possible static image).' });
                                return;
                            }

                            // All checks passed
                            resolve({ isLive: true });
                            return;
                        }

                        try {
                            // Check if video is still playing and is a live stream
                            if (!video || video.paused || video.ended || video.readyState < 2) {
                                consecutiveStaticFrames++;
                                if (consecutiveStaticFrames > maxStaticFrames) {
                                    clearInterval(checkLiveness);
                                    clearTimeout(timeoutId);
                                    resolve({ isLive: false, reason: 'Video stream appears to be static. Please use a live camera.' });
                                    return;
                                }
                                return;
                            }
                            
                            consecutiveStaticFrames = 0; // Reset if video is playing
                            
                            const detections = await faceapi.detectSingleFace(video, 
                                new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.6 }))
                                .withFaceLandmarks();

                            if (detections && detections.detection) {
                                frameCount++;
                                const box = detections.detection.box;
                                const currentPosition = {
                                    x: box.x + box.width / 2,
                                    y: box.y + box.height / 2,
                                    width: box.width,
                                    height: box.height
                                };
                                const currentSize = box.width * box.height;

                                // Track movement
                                if (lastFacePosition) {
                                    const movement = Math.sqrt(
                                        Math.pow(currentPosition.x - lastFacePosition.x, 2) +
                                        Math.pow(currentPosition.y - lastFacePosition.y, 2)
                                    );
                                    movementDistances.push(movement);
                                }
                                lastFacePosition = currentPosition;

                                // Track size variation
                                if (lastFaceSize !== null) {
                                    const sizeChange = Math.abs(currentSize - lastFaceSize);
                                    sizeVariations.push(sizeChange);
                                }
                                lastFaceSize = currentSize;

                                // Calculate Eye Aspect Ratio (EAR) for blink detection
                                const landmarks = detections.landmarks;
                                if (landmarks && landmarks.positions && landmarks.positions.length >= 68) {
                                    try {
                                        const leftEye = [
                                            landmarks.positions[36], landmarks.positions[37],
                                            landmarks.positions[38], landmarks.positions[39],
                                            landmarks.positions[40], landmarks.positions[41]
                                        ];
                                        const rightEye = [
                                            landmarks.positions[42], landmarks.positions[43],
                                            landmarks.positions[44], landmarks.positions[45],
                                            landmarks.positions[46], landmarks.positions[47]
                                        ];

                                        const leftEAR = calculateEAR(leftEye);
                                        const rightEAR = calculateEAR(rightEye);
                                        
                                        // Only add if both eyes detected successfully
                                        if (leftEAR > 0 && rightEAR > 0) {
                                            const avgEAR = (leftEAR + rightEAR) / 2;
                                            eyeAspectRatios.push(avgEAR);
                                        }
                                    } catch (error) {
                                        console.error('Error processing eye landmarks:', error);
                                    }
                                }

                                frames.push({
                                    timestamp: Date.now(),
                                    position: currentPosition,
                                    size: currentSize,
                                    detections: detections
                                });
                            } else {
                                // No face detected in this frame
                                consecutiveStaticFrames++;
                            }
                        } catch (error) {
                            console.error('Liveness check error:', error);
                            consecutiveStaticFrames++;
                            // But if too many errors, fail the check
                            if (error.message && error.message.includes('face-api')) {
                                // Face-api specific error, might be model loading issue
                                clearInterval(checkLiveness);
                                clearTimeout(timeoutId);
                                resolve({ isLive: false, reason: 'Face detection error. Please refresh and try again.' });
                                return;
                            }
                        }
                    }, checkInterval);
                });
            }

            // Calculate Eye Aspect Ratio (for blink detection)
            function calculateEAR(eyePoints) {
                if (!eyePoints || eyePoints.length < 6) {
                    return 0;
                }
                
                // Validate all points exist
                for (let i = 0; i < 6; i++) {
                    if (!eyePoints[i] || typeof eyePoints[i].x === 'undefined' || typeof eyePoints[i].y === 'undefined') {
                        return 0;
                    }
                }
                
                try {
                    const vertical1 = Math.sqrt(
                        Math.pow(eyePoints[1].x - eyePoints[5].x, 2) +
                        Math.pow(eyePoints[1].y - eyePoints[5].y, 2)
                    );
                    const vertical2 = Math.sqrt(
                        Math.pow(eyePoints[2].x - eyePoints[4].x, 2) +
                        Math.pow(eyePoints[2].y - eyePoints[4].y, 2)
                    );
                    const horizontal = Math.sqrt(
                        Math.pow(eyePoints[0].x - eyePoints[3].x, 2) +
                        Math.pow(eyePoints[0].y - eyePoints[3].y, 2)
                    );
                    
                    // Prevent division by zero
                    if (horizontal === 0) {
                        return 0;
                    }
                    
                    return (vertical1 + vertical2) / (2.0 * horizontal);
                } catch (error) {
                    console.error('Error calculating EAR:', error);
                    return 0;
                }
            }

            // Calculate variance
            function calculateVariance(values) {
                if (values.length === 0) return 0;
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                const squareDiffs = values.map(value => Math.pow(value - mean, 2));
                return squareDiffs.reduce((a, b) => a + b, 0) / values.length;
            }

            // Attendance mark button with liveness detection
            markAttendanceBtn.addEventListener('click', async () => {
                if (!loggedInUser) { 
                    showMessage("Not logged in."); 
                    return; 
                }

                // Check if video is available
                if (!videoAttendance || !videoAttendance.srcObject) {
                    showMessage("Camera not available. Please ensure camera access is granted.");
                    return;
                }

                // Disable button during liveness check
                markAttendanceBtn.disabled = true;
                const livenessStatus = document.getElementById('liveness-status');
                const livenessStatusText = document.getElementById('liveness-status-text');
                const markAttendanceBtnText = document.getElementById('mark-attendance-btn-text');
                
                if (livenessStatus && livenessStatusText) {
                    livenessStatus.style.display = 'block';
                    livenessStatusText.textContent = 'Verifying you are live... Please move your head naturally and blink 2-3 times.';
                }
                if (markAttendanceBtnText) {
                    markAttendanceBtnText.textContent = 'Verifying Liveness...';
                }

                // Perform liveness detection first
                let livenessResult;
                try {
                    livenessResult = await performLivenessCheck(videoAttendance, 6000); // 6 seconds for better detection
                } catch (error) {
                    console.error('Liveness check failed:', error);
                    markAttendanceBtn.disabled = false;
                    if (livenessStatus) livenessStatus.style.display = 'none';
                    if (markAttendanceBtnText) markAttendanceBtnText.textContent = 'Mark Attendance with Face Recognition';
                    showMessage('Liveness check encountered an error. Please try again.');
                    return;
                }
                
                if (livenessStatus) livenessStatus.style.display = 'none';
                
                if (!livenessResult.isLive) {
                    markAttendanceBtn.disabled = false;
                    if (markAttendanceBtnText) markAttendanceBtnText.textContent = 'Mark Attendance with Face Recognition';
                    showMessage(`Liveness check failed: ${livenessResult.reason}. Please ensure you are physically present and move naturally.`);
                    return;
                }

                // Liveness passed, now verify face match
                const detections = await faceapi.detectSingleFace(videoAttendance, 
                    new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 }))
                    .withFaceLandmarks().withFaceDescriptor();
                
                if (!detections) { 
                    markAttendanceBtn.disabled = false;
                    if (markAttendanceBtnText) markAttendanceBtnText.textContent = 'Mark Attendance with Face Recognition';
                    showMessage("Face not detected."); 
                    return; 
                }

                const distance = faceapi.euclideanDistance(detections.descriptor, loggedInUser.descriptor);

                if (distance >= 0.6) { 
                    markAttendanceBtn.disabled = false;
                    if (markAttendanceBtnText) markAttendanceBtnText.textContent = 'Mark Attendance with Face Recognition';
                    showMessage("Face does not match logged in user."); 
                    return; 
                }

                // Face matched and liveness verified, now verify location
                if (!navigator.geolocation) { 
                    markAttendanceBtn.disabled = false;
                    if (markAttendanceBtnText) markAttendanceBtnText.textContent = 'Mark Attendance with Face Recognition';
                    showMessage("Geolocation not supported."); 
                    return; 
                }
                
                navigator.geolocation.getCurrentPosition(pos => {
                    const dist = getDistance(pos.coords.latitude, pos.coords.longitude, CLASSROOM_LOCATION.lat, CLASSROOM_LOCATION.lon);
                    if (dist <= RADIUS_METERS) {
                        showMessage("Attendance marked successfully ‚úÖ");
                        markAttendanceBtn.disabled = false;
                        if (markAttendanceBtnText) markAttendanceBtnText.textContent = 'Mark Attendance with Face Recognition';
                        // TODO: Update attendance table dynamically if needed
                    } else {
                        showMessage("Outside classroom ‚ùå Attendance not marked.");
                        markAttendanceBtn.disabled = false;
                        if (markAttendanceBtnText) markAttendanceBtnText.textContent = 'Mark Attendance with Face Recognition';
                    }
                }, err => {
                    showMessage("Location permission denied. Attendance not marked.");
                    markAttendanceBtn.disabled = false;
                    if (markAttendanceBtnText) markAttendanceBtnText.textContent = 'Mark Attendance with Face Recognition';
                });
            });

            // ===== Dashboard Tab Functionality =====
            let currentTab = 'dashboard';
            
            // Function to switch tabs programmatically
            window.switchTab = function(tabId) {
                const button = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
                if (button) {
                    button.click();
                }
            };

            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    if (tabId !== currentTab) {
                        if (currentTab === 'attendance') {
                            if (videoAttendance.srcObject) {
                                videoAttendance.srcObject.getTracks().forEach(t => t.stop());
                                videoAttendance.pause();
                            }
                            if (attendanceInterval) clearInterval(attendanceInterval);
                            isVideoAttendancePlaying = false;
                            markAttendanceBtn.disabled = true;
                        }
                        currentTab = tabId;
                    }

                    // Deactivate all tabs
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        if (btn.classList.contains('text-blue-400')) {
                            btn.classList.remove('text-blue-400', 'bg-blue-900', 'border-blue-400');
                        }
                        btn.classList.add('text-gray-400');
                    });

                    // Activate clicked tab
                    if (button.classList.contains('text-gray-400')) {
                        button.classList.remove('text-gray-400');
                    }
                    button.classList.add('text-blue-400');

                    // For mobile tabs with border
                    if (button.classList.contains('border-b-2')) {
                        button.classList.add('border-blue-400');
                    }

                    // For desktop tabs with background
                    if (!button.classList.contains('border-b-2')) {
                        button.classList.add('bg-blue-900');
                    }

                    // Hide all tab content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });

                    // Show selected tab content
                    document.getElementById(tabId).classList.add('active');

                    if (tabId === 'attendance' && loggedInUser) {
                        startVideo(videoAttendance, canvasAttendance, 'attendance');
                    }
                    
                    // Refresh timetable when timetable tab is accessed
                    if (tabId === 'timetable') {
                        // Update batch info and refresh timetable
                        if (typeof updateTimetableBatchInfo === 'function') {
                            updateTimetableBatchInfo();
                        }
                        if (typeof renderTimetable === 'function') {
                            // Get current day or default to Monday
                            let currentDay = 'Mon';
                            const activeDayBtn = document.querySelector('#timetable button.bg-blue-700[onclick*="changeDay"]');
                            if (activeDayBtn) {
                                const onclickAttr = activeDayBtn.getAttribute('onclick');
                                const match = onclickAttr ? onclickAttr.match(/changeDay\('(\w+)'\)/) : null;
                                if (match && match[1] && ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].includes(match[1])) {
                                    currentDay = match[1];
                                }
                            }
                            renderTimetable(currentDay);
                        }
                    }
                    
                    // Initialize skills when profile tab is accessed
                    if (tabId === 'profile') {
                        setTimeout(initSkills, 100);
                    }
                });
            });

            // ===== Dashboard Initialization =====
            function initializeDashboard() {
                // Update date and time
                function updateDateTime() {
                    const now = new Date();
                    const dateEl = document.getElementById('dashboard-date');
                    const timeEl = document.getElementById('dashboard-time');
                    
                    if (dateEl) {
                        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                        dateEl.textContent = now.toLocaleDateString('en-US', options);
                    }
                    
                    if (timeEl) {
                        timeEl.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    }
                }
                
                // Update stats
                function updateDashboardStats() {
                    // Get attendance data from localStorage
                    const attendanceData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
                    const today = new Date().toDateString();
                    const todayAttendance = attendanceData.filter(a => new Date(a.date).toDateString() === today);
                    
                    // Update attendance count
                    const attendanceCountEl = document.getElementById('attendance-count');
                    if (attendanceCountEl) {
                        const totalToday = 4; // Total classes today (can be dynamic)
                        attendanceCountEl.textContent = `${todayAttendance.length}/${totalToday}`;
                    }
                    
                    // Update upcoming classes
                    const upcomingClassesEl = document.getElementById('upcoming-classes');
                    if (upcomingClassesEl) {
                        const now = new Date();
                        const currentHour = now.getHours();
                        // Count classes after current time (simplified)
                        upcomingClassesEl.textContent = '2'; // Can be calculated from timetable
                    }
                    
                    // Update week attendance
                    const weekAttendanceEl = document.getElementById('week-attendance');
                    if (weekAttendanceEl) {
                        const weekStart = new Date();
                        weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                        const weekAttendance = attendanceData.filter(a => new Date(a.date) >= weekStart);
                        const weekTotal = 20; // Total classes in week
                        const percentage = weekTotal > 0 ? Math.round((weekAttendance.length / weekTotal) * 100) : 0;
                        weekAttendanceEl.textContent = `${percentage}%`;
                    }
                    
                    // Update total classes
                    const totalClassesEl = document.getElementById('total-classes');
                    if (totalClassesEl) {
                        totalClassesEl.textContent = '12'; // Total enrolled classes
                    }
                }
                
                // Update schedule from timetable data
                function updateDashboardSchedule() {
                    const scheduleEl = document.getElementById('dashboard-schedule');
                    if (!scheduleEl) return;
                    
                    try {
                        const timetableData = JSON.parse(localStorage.getItem('timetableData') || '{}');
                        const today = new Date().getDay();
                        const dayMap = { 1: 'Mon', 2: 'Tue', 3: 'Wed', 4: 'Thu', 5: 'Fri' };
                        const currentDay = dayMap[today] || 'Mon';
                        const todaySchedule = timetableData[currentDay] || [];
                        
                        if (todaySchedule.length > 0) {
                            scheduleEl.innerHTML = todaySchedule.slice(0, 3).map(entry => {
                                const statusColors = {
                                    'Completed': 'bg-green-800 text-green-200',
                                    'In Progress': 'bg-yellow-800 text-yellow-200',
                                    'Upcoming': 'bg-blue-800 text-blue-200',
                                    '': 'bg-gray-800 text-gray-200'
                                };
                                const statusClass = statusColors[entry.status] || 'bg-gray-800 text-gray-200';
                                
                                return `
                                    <div class="flex items-center p-3 bg-gray-700 rounded-lg">
                                        <div class="bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded mr-3">${escapeHtml(entry.time || '')}</div>
                        <div class="flex-1">
                                            <div class="font-medium text-white">${escapeHtml(entry.subject || '')}</div>
                                            <div class="text-xs text-gray-400">${escapeHtml(entry.room || '')}${entry.teacher ? ' ‚Ä¢ ' + escapeHtml(entry.teacher) : ''}</div>
                        </div>
                                        ${entry.status ? `<span class="${statusClass} text-xs px-2 py-1 rounded-full">${escapeHtml(entry.status)}</span>` : ''}
                    </div>
                                `;
                            }).join('');
                        }
                    } catch (e) {
                        console.error('Error updating schedule:', e);
                    }
                }
                
                // Initial updates
                updateDateTime();
                updateDashboardStats();
                updateDashboardSchedule();
                
                // Update time every minute
                setInterval(updateDateTime, 60000);
            }

            // ===== Editable Timetable System =====
            // Helper function to escape HTML (prevent XSS)
            function escapeHtml(s) {
                if (s === null || s === undefined) return '';
                return ('' + s).replace(/[&<>"']/g, c => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                })[c]);
            }

            // Load timetable data from batch-specific timetables (read-only for students)
            function loadTimetableData() {
                // Get student's email and username from profile
                let studentEmail = null;
                let studentUsername = null;
                try {
                    const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    studentEmail = savedProfile.email || null;
                    studentUsername = savedProfile.username || savedProfile.name || null;
                } catch (e) {
                    console.error('Error loading profile:', e);
                }

                // Find which batch the student belongs to
                let studentBatch = null;
                
                // First, try to get batch directly from profile (set during registration)
                try {
                    const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    studentBatch = savedProfile.batch || savedProfile.id || null;
                } catch (e) {
                    // Ignore
                }
                
                // If no batch in profile, try to find by email or username in batch lists
                if (!studentBatch) {
                    try {
                        const batches = JSON.parse(localStorage.getItem('adminBatches') || '{}');
                        // Find batch that contains this student's email or username
                        for (const [batchName, emails] of Object.entries(batches)) {
                            if (Array.isArray(emails)) {
                                if ((studentEmail && emails.includes(studentEmail)) || 
                                    (studentUsername && emails.includes(studentUsername))) {
                                    studentBatch = batchName;
                                    break;
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error loading batches:', e);
                    }
                }

                // Load batch timetables
                let batchTimetables = {};
                try {
                    const data = localStorage.getItem('batchTimetables');
                    if (data) {
                        batchTimetables = JSON.parse(data);
                    }
                } catch (e) {
                    console.error('Error loading batch timetables:', e);
                }

                // Convert batch timetable format to student timetable format
                const timetableData = {
                    'Mon': [],
                    'Tue': [],
                    'Wed': [],
                    'Thu': [],
                    'Fri': []
                };

                if (studentBatch && batchTimetables) {
                    ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].forEach(day => {
                        const batchKey = `${studentBatch}_${day}`;
                        const batchTimetable = batchTimetables[batchKey] || [];
                        
                        // Convert to student timetable format
                        timetableData[day] = batchTimetable.map((entry, index) => ({
                            id: Date.now() + index + (day.charCodeAt(0) * 1000),
                            time: entry.time || '',
                            subject: entry.subject || '',
                            room: entry.room || '',
                            teacher: '', // Not stored in batch timetable
                            status: '',
                            borderColor: ''
                        }));
                    });
                }

                return timetableData;
            }

            function saveTimetableData() {
                // Only save if timetableData exists and is not empty
                if (!timetableData || typeof timetableData !== 'object') {
                    console.warn('Timetable data is not available for saving');
                    return;
                }
                try {
                    localStorage.setItem('timetableData', JSON.stringify(timetableData));
                } catch (e) {
                    console.error('Error saving timetable data:', e);
                    // Handle quota exceeded or other storage errors
                    if (e.name === 'QuotaExceededError') {
                        alert('Unable to save timetable data. Your browser storage may be full.');
                    }
                }
            }

            let timetableData = loadTimetableData();
            let currentDay = 'Mon';

            function getStatusColors(status) {
                const colors = {
                    'Upcoming': { bg: 'bg-blue-800', text: 'text-blue-200' },
                    'Ongoing': { bg: 'bg-yellow-800', text: 'text-yellow-200' },
                    'Completed': { bg: 'bg-green-800', text: 'text-green-200' },
                    'Not Completed': { bg: 'bg-red-800', text: 'text-red-200' },
                    'Pending': { bg: 'bg-red-800', text: 'text-red-200' }, // Legacy support
                    'In Progress': { bg: 'bg-yellow-800', text: 'text-yellow-200' }, // Legacy support
                    '': { bg: '', text: '' }
                };
                return colors[status] || { bg: 'bg-gray-800', text: 'text-gray-200' };
            }

            function getBorderColorClass(color) {
                const colors = {
                    'blue': 'border-blue-500',
                    'green': 'border-green-500',
                    'yellow': 'border-yellow-500',
                    'red': 'border-red-500',
                    'purple': 'border-purple-500',
                    'gray': 'border-gray-500'
                };
                return colors[color] || 'border-blue-500';
            }

            function getBgColorClass(color) {
                const colors = {
                    'blue': 'bg-blue-900',
                    'green': 'bg-green-900',
                    'yellow': 'bg-yellow-900',
                    'red': 'bg-red-900',
                    'purple': 'bg-purple-900',
                    'gray': 'bg-gray-700'
                };
                return colors[color] || 'bg-blue-900';
            }

            function getTextColorClass(color) {
                const colors = {
                    'blue': 'text-blue-200',
                    'green': 'text-green-200',
                    'yellow': 'text-yellow-200',
                    'red': 'text-red-200',
                    'purple': 'text-purple-200',
                    'gray': 'text-gray-300'
                };
                return colors[color] || 'text-blue-200';
            }

            // Determine lecture status and color based on system time
            function getLectureStatusAndColor(entryTime, day) {
                const now = new Date();
                const currentDay = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
                const dayMap = { 'Mon': 1, 'Tue': 2, 'Wed': 3, 'Thu': 4, 'Fri': 5 };
                const entryDay = dayMap[day];
                
                // Parse time (format: "HH:MM" or "HH:MM AM/PM")
                function parseTime(timeStr) {
                    if (!timeStr) return null;
                    
                    let time = timeStr.trim();
                    let hours = 0, minutes = 0;
                    
                    // Handle 12-hour format
                    if (time.includes('AM') || time.includes('PM') || time.includes('am') || time.includes('pm')) {
                        const parts = time.split(/[:\s]/);
                        hours = parseInt(parts[0]) || 0;
                        minutes = parseInt(parts[1]) || 0;
                        const period = (parts[parts.length - 1] || '').toUpperCase();
                        
                        if (period === 'PM' && hours !== 12) hours += 12;
                        if (period === 'AM' && hours === 12) hours = 0;
                    } else {
                        // Handle 24-hour format
                        const parts = time.split(':');
                        hours = parseInt(parts[0]) || 0;
                        minutes = parseInt(parts[1]) || 0;
                    }
                    
                    return { hours, minutes };
                }
                
                const entryTimeObj = parseTime(entryTime);
                if (!entryTimeObj) {
                    return { status: 'Pending', color: 'red' };
                }
                
                // Create date objects for comparison
                const entryDate = new Date();
                entryDate.setHours(entryTimeObj.hours, entryTimeObj.minutes, 0, 0);
                
                // Adjust for day of week (only if viewing today's day)
                if (entryDay !== undefined && entryDay === currentDay) {
                    // Same day - compare times directly
                    // No date adjustment needed
                } else if (entryDay !== undefined) {
                    // Different day - calculate day difference
                    const dayDiff = entryDay - currentDay;
                    // Handle weekend wrap-around
                    let adjustedDiff = dayDiff;
                    if (dayDiff > 3) adjustedDiff = dayDiff - 7; // Next week
                    if (dayDiff < -3) adjustedDiff = dayDiff + 7; // Last week
                    entryDate.setDate(entryDate.getDate() + adjustedDiff);
                }
                
                const currentTime = new Date();
                const lectureEndTime = new Date(entryDate);
                lectureEndTime.setHours(lectureEndTime.getHours() + 1); // Assume 1 hour lecture duration
                
                // Determine status with new color scheme
                if (currentTime < entryDate) {
                    // Future lecture - Upcoming (Blue)
                    return { status: 'Upcoming', color: 'blue' };
                } else if (currentTime >= entryDate && currentTime <= lectureEndTime) {
                    // Current lecture - Ongoing (Yellow)
                    return { status: 'Ongoing', color: 'yellow' };
                } else {
                    // Past lecture - check if it was actually completed
                    // For now, mark as Completed (Green) - can be enhanced later with attendance data
                    return { status: 'Completed', color: 'green' };
                }
            }

            function renderTimetable(day) {
                const content = document.getElementById('timetableContent');
                if (!content) return;
                
                // Update batch info display
                updateTimetableBatchInfo();
                
                // Reload timetable data to get latest from batch
                timetableData = loadTimetableData();
                
                // Ensure day exists in data structure
                if (!timetableData[day]) {
                    timetableData[day] = [];
                }
                
                const entries = timetableData[day] || [];
                
                if (entries.length === 0) {
                    // Check if batch is assigned
                    try {
                        const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                        const studentBatch = savedProfile.batch || savedProfile.id || null;
                        
                        if (!studentBatch) {
                            content.innerHTML = '<div class="text-center text-gray-400 py-8"><p class="mb-2">No batch assigned.</p><p class="text-sm">Please select a batch during registration or contact your admin.</p></div>';
                        } else {
                            content.innerHTML = `<div class="text-center text-gray-400 py-8"><p class="mb-2">No timetable entries for ${day}.</p><p class="text-sm">Batch: <span class="text-blue-400">${escapeHtml(studentBatch)}</span></p><p class="text-sm mt-2">Please contact your admin to set up the timetable.</p></div>`;
                        }
                    } catch (e) {
                        content.innerHTML = '<div class="text-center text-gray-400 py-8">No timetable entries for this day. Please contact your admin.</div>';
                    }
                    return;
                }

                content.innerHTML = entries.map(entry => {
                    // Validate entry structure
                    if (!entry || typeof entry.id === 'undefined') {
                        return '';
                    }
                    
                    // Get status and color based on system time
                    const { status, color } = getLectureStatusAndColor(entry.time, day);
                    
                    // Update entry status automatically
                    entry.status = status;
                    entry.borderColor = color; // Store for reference but it's auto-calculated
                    
                    const statusColors = getStatusColors(status);
                    const borderClass = getBorderColorClass(color);
                    const bgClass = getBgColorClass(color);
                    const textClass = getTextColorClass(color);
                    const statusBadge = status ? 
                        `<div class="${statusColors.bg} ${statusColors.text} text-xs px-2 py-1 rounded-full">${escapeHtml(status)}</div>` : '';

                    // Escape all user input to prevent XSS
                    const safeTime = escapeHtml(entry.time || '');
                    const safeSubject = escapeHtml(entry.subject || '');
                    const safeRoom = escapeHtml(entry.room || '');
                    const safeTeacher = escapeHtml(entry.teacher || '');

                    // Read-only view for students - no edit/delete buttons
                    return `
                        <div class="flex items-center p-4 border-l-4 ${borderClass} ${bgClass} rounded-lg timetable-entry" data-id="${entry.id}">
                            <div class="w-20 ${textClass} font-bold">${safeTime}</div>
                            <div class="flex-1 ml-4">
                                <h3 class="font-semibold">${safeSubject}</h3>
                                <p class="text-sm text-gray-400">
                                    Room: <span class="text-gray-300">${safeRoom}</span>
                                    ${safeTeacher ? ` ‚Ä¢ <span class="text-gray-300">${safeTeacher}</span>` : ''}
                                </p>
                        </div>
                            <div class="flex items-center gap-2">
                                ${statusBadge}
                            </div>
                    </div>
                `;
                }).filter(html => html !== '').join('');

                // No event listeners needed - timetable is read-only for students

                // Auto-update timetable every minute to reflect current time
                if (window.timetableUpdateInterval) {
                    clearInterval(window.timetableUpdateInterval);
                }
                window.timetableUpdateInterval = setInterval(() => {
                    const timetableContent = document.getElementById('timetableContent');
                    if (timetableContent && !timetableContent.closest('.hidden')) {
                        // Get the active day from buttons with blue background (active state)
                        let activeDay = currentDay || 'Mon';
                        const activeDayBtn = document.querySelector('#timetable button.bg-blue-700[onclick*="changeDay"]');
                        if (activeDayBtn) {
                            const onclickAttr = activeDayBtn.getAttribute('onclick');
                            const match = onclickAttr ? onclickAttr.match(/changeDay\('(\w+)'\)/) : null;
                            if (match && match[1] && ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].includes(match[1])) {
                                activeDay = match[1];
                            }
                        }
                        // Ensure activeDay is valid
                        if (!['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].includes(activeDay)) {
                            activeDay = 'Mon';
                        }
                        if (activeDay) {
                            renderTimetable(activeDay);
                        }
                    }
                }, 60000); // Update every minute
            }

            function saveEntry(id) {
                const entryDiv = document.querySelector(`.timetable-entry[data-id="${id}"]`);
                if (!entryDiv) {
                    console.error('Entry not found:', id);
                    return;
                }

                // Ensure currentDay data exists
                if (!timetableData[currentDay]) {
                    timetableData[currentDay] = [];
                }

                const entry = timetableData[currentDay].find(e => e.id === id);
                if (!entry) {
                    console.error('Entry data not found:', id);
                    return;
                }

                const subjectEl = entryDiv.querySelector('.editable-subject');
                const roomEl = entryDiv.querySelector('.editable-room');

                if (!subjectEl) {
                    console.error('Required elements not found');
                    return;
                }

                // Sanitize and save (only subject and room are editable)
                entry.subject = subjectEl.textContent.trim() || 'New Subject';
                if (roomEl) {
                    entry.room = roomEl.textContent.trim() || entry.room || '';
                }

                // Status and color are auto-calculated based on time; do not set them here

                // Save to localStorage
                saveTimetableData();

                // Show save confirmation
                const btn = entryDiv.querySelector('.edit-entry-btn');
                if (btn) {
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    btn.classList.add('bg-green-600');
                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.classList.remove('bg-green-600');
                        btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }, 1000);
                }
            }

            function deleteEntry(id) {
                if (!confirm('Are you sure you want to delete this entry?')) {
                    return;
                }
                
                // Ensure currentDay data exists
                if (!timetableData[currentDay]) {
                    timetableData[currentDay] = [];
                }
                
                const initialLength = timetableData[currentDay].length;
                timetableData[currentDay] = timetableData[currentDay].filter(e => e.id !== id);
                
                // Only save and re-render if something was actually deleted
                if (timetableData[currentDay].length < initialLength) {
                    saveTimetableData();
                    renderTimetable(currentDay);
                }
            }

            function addNewEntry() {
                // Ensure currentDay data exists
                if (!timetableData[currentDay]) {
                    timetableData[currentDay] = [];
                }
                
                // Generate unique ID (use timestamp + random to avoid collisions)
                const newEntry = {
                    id: Date.now() + Math.random(),
                    time: '9:00',
                    subject: 'New Subject',
                    room: 'Room',
                    teacher: 'Teacher',
                    status: '', // Will be auto-calculated
                    borderColor: '' // Will be auto-calculated
                };
                
                timetableData[currentDay].push(newEntry);
                saveTimetableData();
                renderTimetable(currentDay);
            }

            // ===== Timetable Day Change =====
            window.changeDay = function (day, event) {
                // Validate day
                const validDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
                if (!validDays.includes(day)) {
                    console.error('Invalid day:', day);
                    return;
                }
                
                // Update button styles - use more reliable selector
                const buttons = document.querySelectorAll('#timetable button[onclick*="changeDay"]');
                buttons.forEach(btn => {
                    const btnDay = btn.getAttribute('onclick')?.match(/changeDay\('(\w+)'\)/)?.[1];
                    if (btnDay === day) {
                        btn.classList.add('bg-blue-700', 'text-white');
                        btn.classList.remove('bg-gray-700', 'text-gray-300');
                    } else {
                        btn.classList.remove('bg-blue-700', 'text-white');
                        btn.classList.add('bg-gray-700', 'text-gray-300');
                    }
                });
                
                // Update date and time with real-time values
                updateTimetableDateTime(day);
                currentDay = day;
                renderTimetable(day);
            }

            // Update real-time date and time in timetable
            function updateTimetableDateTime(day) {
                if (!day) return; // Safety check
                
                const now = new Date();
                const dateEl = document.getElementById('currentDate');
                const timeEl = document.getElementById('currentTime');
                
                if (dateEl) {
                    // Get the actual date for the selected day of week
                    const dayMap = { 'Mon': 1, 'Tue': 2, 'Wed': 3, 'Thu': 4, 'Fri': 5 };
                    const currentDayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
                    const targetDay = dayMap[day];
                    
                    if (targetDay !== undefined) {
                        // Calculate days difference
                        let daysDiff = targetDay - currentDayOfWeek;
                        
                        // If the target day has already passed this week, show next week
                        if (daysDiff < 0) {
                            daysDiff += 7;
                        }
                        // If it's Sunday (0) and we want Monday (1), show next Monday
                        if (daysDiff === 0 && currentDayOfWeek === 0) {
                            daysDiff = 1;
                        }
                        // If today is the target day, show today
                        if (daysDiff === 0) {
                            daysDiff = 0;
                        }
                        
                        const targetDate = new Date(now);
                        targetDate.setDate(now.getDate() + daysDiff);
                        
                        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                        dateEl.textContent = targetDate.toLocaleDateString('en-US', options);
                    }
                }
                
                if (timeEl) {
                    // Update time every second
                    timeEl.textContent = now.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit',
                        hour12: false 
                    });
                }
            }

            // Initialize real-time clock for timetable
            function initTimetableClock() {
                // Clear any existing interval to prevent duplicates
                if (window.timetableClockInterval) {
                    clearInterval(window.timetableClockInterval);
                }
                
                // Update immediately
                if (currentDay) {
                    updateTimetableDateTime(currentDay);
                }
                
                // Update every second
                window.timetableClockInterval = setInterval(() => {
                    if (currentDay) {
                        updateTimetableDateTime(currentDay);
                    }
                }, 1000);
            }

            // Export timetable to PDF
            function exportTimetableToPDF() {
                try {
                    // Check if jsPDF is available
                    if (typeof window.jspdf === 'undefined') {
                        showMessage('PDF library not loaded. Please refresh the page.', 'error');
                        return;
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Reload timetable data
                    const data = loadTimetableData();
                    
                    // Get student info
                    let studentName = 'Student';
                    let studentEmail = '';
                    let batchName = '';
                    try {
                        const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                        studentName = savedProfile.name || savedProfile.username || 'Student';
                        studentEmail = savedProfile.email || '';
                        
                        // Find batch
                        if (studentEmail) {
                            const batches = JSON.parse(localStorage.getItem('adminBatches') || '{}');
                            for (const [batch, emails] of Object.entries(batches)) {
                                if (Array.isArray(emails) && emails.includes(studentEmail)) {
                                    batchName = batch;
                                    break;
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error loading profile:', e);
                    }
                    
                    // Set up PDF
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 15;
                    let yPos = margin;
                    
                    // Title
                    doc.setFontSize(18);
                    doc.setFont(undefined, 'bold');
                    doc.text('Weekly Timetable', pageWidth / 2, yPos, { align: 'center' });
                    yPos += 10;
                    
                    // Student info
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Student: ${studentName}`, margin, yPos);
                    yPos += 6;
                    if (studentEmail) {
                        doc.text(`Email: ${studentEmail}`, margin, yPos);
                        yPos += 6;
                    }
                    if (batchName) {
                        doc.text(`Batch: ${batchName}`, margin, yPos);
                        yPos += 6;
                    }
                    
                    // Date
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    doc.text(`Generated: ${dateStr}`, margin, yPos);
                    yPos += 10;
                    
                    // Table setup
                    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
                    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                    const colWidth = (pageWidth - 2 * margin - 40) / 5; // 40 for time column
                    const timeColWidth = 40;
                    const rowHeight = 8;
                    const startX = margin;
                    let currentY = yPos;
                    
                    // Table header
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.setFillColor(100, 100, 100);
                    doc.rect(startX, currentY, timeColWidth, rowHeight, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.text('Time', startX + timeColWidth / 2, currentY + 5, { align: 'center' });
                    
                    days.forEach((day, idx) => {
                        const xPos = startX + timeColWidth + (idx * colWidth);
                        doc.rect(xPos, currentY, colWidth, rowHeight, 'F');
                        doc.text(dayNames[idx], xPos + colWidth / 2, currentY + 5, { align: 'center' });
                    });
                    
                    doc.setTextColor(0, 0, 0);
                    currentY += rowHeight;
                    
                    // Collect all unique times across all days
                    const allTimes = new Set();
                    days.forEach(day => {
                        const entries = data[day] || [];
                        entries.forEach(entry => {
                            if (entry.time) {
                                allTimes.add(entry.time);
                            }
                        });
                    });
                    
                    // Sort times
                    const sortedTimes = Array.from(allTimes).sort((a, b) => {
                        const parseTime = (timeStr) => {
                            if (!timeStr) return 0;
                            let time = timeStr.trim();
                            let hours = 0, minutes = 0;
                            
                            if (time.includes('AM') || time.includes('PM') || time.includes('am') || time.includes('pm')) {
                                const parts = time.split(/[:\s]/);
                                hours = parseInt(parts[0]) || 0;
                                minutes = parseInt(parts[1]) || 0;
                                const period = (parts[2] || '').toUpperCase();
                                if (period === 'PM' && hours !== 12) hours += 12;
                                if (period === 'AM' && hours === 12) hours = 0;
                            } else {
                                const parts = time.split(':');
                                hours = parseInt(parts[0]) || 0;
                                minutes = parseInt(parts[1]) || 0;
                            }
                            return hours * 60 + minutes;
                        };
                        return parseTime(a) - parseTime(b);
                    });
                    
                    // Draw table rows
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    
                    sortedTimes.forEach((time, timeIdx) => {
                        // Check if we need a new page
                        if (currentY + rowHeight > pageHeight - margin) {
                            doc.addPage();
                            currentY = margin;
                        }
                        
                        // Time column
                        doc.setFillColor(240, 240, 240);
                        doc.rect(startX, currentY, timeColWidth, rowHeight, 'F');
                        doc.setTextColor(0, 0, 0);
                        doc.text(time, startX + timeColWidth / 2, currentY + 5, { align: 'center' });
                        
                        // Day columns
                        days.forEach((day, dayIdx) => {
                            const xPos = startX + timeColWidth + (dayIdx * colWidth);
                            const entries = data[day] || [];
                            const entry = entries.find(e => e.time === time);
                            
                            doc.setFillColor(255, 255, 255);
                            doc.rect(xPos, currentY, colWidth, rowHeight, 'F');
                            doc.setDrawColor(200, 200, 200);
                            doc.rect(xPos, currentY, colWidth, rowHeight);
                            
                            if (entry) {
                                doc.setTextColor(0, 0, 0);
                                const subject = (entry.subject || '').substring(0, 15);
                                const room = entry.room ? ` (${entry.room})` : '';
                                const text = subject + room;
                                doc.text(text, xPos + 2, currentY + 4, { maxWidth: colWidth - 4 });
                            }
                        });
                        
                        currentY += rowHeight;
                    });
                    
                    // Save PDF
                    const fileName = `Timetable_${studentName.replace(/\s+/g, '_')}_${batchName || 'All'}_${now.getFullYear()}_${String(now.getMonth() + 1).padStart(2, '0')}_${String(now.getDate()).padStart(2, '0')}.pdf`;
                    doc.save(fileName);
                    
                    showMessage('Timetable exported to PDF successfully!', 'success');
                } catch (error) {
                    console.error('Error exporting PDF:', error);
                    showMessage('Error exporting PDF. Please try again.', 'error');
                }
            }

            // Initialize timetable
            // Update timetable batch info display
            function updateTimetableBatchInfo() {
                const batchInfoEl = document.getElementById('timetable-batch-info');
                if (!batchInfoEl) return;
                
                try {
                    const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    const studentBatch = savedProfile.batch || savedProfile.id || null;
                    
                    if (studentBatch) {
                        batchInfoEl.innerHTML = `<span class="text-blue-400 font-medium">Batch: <span class="text-white">${escapeHtml(studentBatch)}</span></span>`;
                    } else {
                        batchInfoEl.innerHTML = '<span class="text-yellow-400">No batch assigned</span>';
                    }
                } catch (e) {
                    console.error('Error updating batch info:', e);
                    batchInfoEl.innerHTML = '';
                }
            }

            function initTimetable() {
                const addBtn = document.getElementById('addTimetableEntry');
                // Hide "Add Entry" button for students - timetable is read-only
                if (addBtn) {
                    addBtn.style.display = 'none';
                }
                
                // Add PDF export button event listener
                const exportPdfBtn = document.getElementById('exportTimetablePDF');
                if (exportPdfBtn) {
                    exportPdfBtn.addEventListener('click', exportTimetableToPDF);
                }
                
                // Update batch info
                updateTimetableBatchInfo();
                
                // Initialize with Monday
                if (document.getElementById('timetableContent')) {
                    renderTimetable('Mon');
                }
                
                // Initialize real-time clock
                initTimetableClock();
            }

            // Initialize on page load
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initTimetable);
            } else {
                initTimetable();
            }

            // ===== Suggestions Start Buttons =====
            window.startSuggestion = function (type) {
                const links = {
                    'algorithms': 'https://leetcode.com/problemset/javascript/',
                    'ml': 'https://arxiv.org/list/cs.LG/recent',
                    'ds': 'https://www.geeksforgeeks.org/data-structures/',
                    'project': 'https://trello.com'
                };
                window.open(links[type] || 'https://example.com', '_blank');
            }

            // ===== Profile Photo Change =====
            const profilePhoto = document.getElementById('profile-photo');
            const profilePhotoInput = document.getElementById('profile-photo-input');
            const changePhotoBtn = document.getElementById('change-photo-btn');

            // Function to handle photo selection and preview
            function handlePhotoChange(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showMessage('Please select a valid image file.');
                    return;
                }

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showMessage('Image size should be less than 5MB.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    
                    // Update all profile photos
                    updateAllProfilePhotos(imageData);
                    
                    // Save to localStorage immediately
                    const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    savedProfile.photo = imageData;
                    localStorage.setItem('userProfile', JSON.stringify(savedProfile));
                    
                    showMessage('Photo updated successfully!');
                };
                reader.onerror = function() {
                    showMessage('Error reading image file.');
                };
                reader.readAsDataURL(file);
            }

            // Add event listeners
            if (changePhotoBtn && profilePhotoInput) {
                changePhotoBtn.addEventListener('click', () => {
                    profilePhotoInput.click();
                });
            }

            if (profilePhoto && profilePhotoInput) {
                profilePhoto.addEventListener('click', () => {
                    profilePhotoInput.click();
                });
            }

            if (profilePhotoInput) {
                profilePhotoInput.addEventListener('change', handlePhotoChange);
            }

            // ===== Skills Management =====
            function renderSkills(skills) {
                const container = document.getElementById('skills-container');
                if (!container) return;
                
                container.innerHTML = skills.map(skill => `
                    <span class="bg-blue-900 text-blue-200 px-3 py-1 rounded-full text-sm flex items-center gap-2 skill-tag" data-skill="${escapeHtml(skill)}">
                        ${escapeHtml(skill)}
                        <button class="remove-skill-btn text-blue-300 hover:text-red-400 transition" data-skill="${escapeHtml(skill)}" title="Remove">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </span>
                `).join('');
                
                // Attach remove event listeners
                container.querySelectorAll('.remove-skill-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const skillToRemove = this.getAttribute('data-skill');
                        removeSkill(skillToRemove);
                    });
                });
            }

            function addSkill() {
                const input = document.getElementById('new-skill-input');
                if (!input) return;
                
                const skill = input.value.trim();
                if (!skill) {
                    showMessage('Please enter a skill or interest.');
                    return;
                }
                
                // Get current skills
                const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                const currentSkills = savedProfile.skills || [];
                
                // Check if skill already exists
                if (currentSkills.includes(skill)) {
                    showMessage('This skill is already added.');
                    input.value = '';
                    return;
                }
                
                // Add skill
                currentSkills.push(skill);
                savedProfile.skills = currentSkills;
                localStorage.setItem('userProfile', JSON.stringify(savedProfile));
                
                // Update UI
                renderSkills(currentSkills);
                input.value = '';
                showMessage('Skill added successfully!');
            }

            function removeSkill(skill) {
                const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                const currentSkills = savedProfile.skills || [];
                
                // Remove skill
                const updatedSkills = currentSkills.filter(s => s !== skill);
                savedProfile.skills = updatedSkills;
                localStorage.setItem('userProfile', JSON.stringify(savedProfile));
                
                // Update UI
                renderSkills(updatedSkills);
                showMessage('Skill removed successfully!');
            }

            // Initialize skills functionality
            let skillsInitialized = false;
            function initSkills() {
                // Prevent duplicate initialization
                if (skillsInitialized) {
                    // Just render skills if already initialized
                    try {
                        const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                        const skills = savedProfile.skills || ['Skills'];
                        renderSkills(skills);
                    } catch (e) {
                        console.error('Error loading skills:', e);
                        renderSkills(['Web Development', 'Machine Learning', 'Data Structures', 'Algorithms']);
                    }
                    return;
                }
                
                const addSkillBtn = document.getElementById('add-skill-btn');
                const newSkillInput = document.getElementById('new-skill-input');
                
                if (addSkillBtn && !addSkillBtn.hasAttribute('data-listener-attached')) {
                    addSkillBtn.addEventListener('click', addSkill);
                    addSkillBtn.setAttribute('data-listener-attached', 'true');
                }
                
                if (newSkillInput && !newSkillInput.hasAttribute('data-listener-attached')) {
                    newSkillInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            addSkill();
                        }
                    });
                    newSkillInput.setAttribute('data-listener-attached', 'true');
                }
                
                // Load existing skills
                try {
                    const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    const skills = savedProfile.skills || ['Web Development', 'Machine Learning', 'Data Structures', 'Algorithms'];
                    renderSkills(skills);
                } catch (e) {
                    console.error('Error loading skills:', e);
                    // Default skills
                    renderSkills(['Web Development', 'Machine Learning', 'Data Structures', 'Algorithms']);
                }
                
                skillsInitialized = true;
            }

            // ===== Profile Save =====
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', () => {
                const profilePhotoEl = document.getElementById('profile-photo');
                const nameEl = document.getElementById('profile-name');
                const idEl = document.getElementById('profile-id');
                const emailEl = document.getElementById('profile-email');
                const courseEl = document.getElementById('profile-course');
                const goalsEl = document.getElementById('profile-goals');
                const sidebarUsernameEl = document.getElementById('sidebar-username');
                const sidebarIdEl = document.getElementById('sidebar-id');
                
                const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                
                const profile = {
                    name: nameEl ? nameEl.value : '',
                    id: idEl ? idEl.value : '',
                    email: emailEl ? emailEl.value : '',
                    course: courseEl ? courseEl.value : '',
                    goals: goalsEl ? goalsEl.value : '',
                    photo: profilePhotoEl ? profilePhotoEl.src : null,
                    skills: savedProfile.skills || [] // Preserve skills
                };
                
                try {
                localStorage.setItem('userProfile', JSON.stringify(profile));
                } catch (e) {
                    console.error('Error saving profile:', e);
                    showMessage('Unable to save profile. Your browser storage may be full.');
                    return;
                }
                
                // Update sidebar if logged in
                if (sidebarUsernameEl) {
                    sidebarUsernameEl.textContent = profile.name;
                }
                if (sidebarIdEl) {
                    sidebarIdEl.textContent = profile.id;
                }
                
                // Update all profile photos
                if (profile.photo) {
                    updateAllProfilePhotos(profile.photo);
                }
                
                showMessage('Profile saved successfully!');
            });
            }

            // Load profile on init (after login, but for demo)
            try {
                const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                if (savedProfile && Object.keys(savedProfile).length > 0) {
                    const nameEl = document.getElementById('profile-name');
                    const idEl = document.getElementById('profile-id');
                    const emailEl = document.getElementById('profile-email');
                    const courseEl = document.getElementById('profile-course');
                    const goalsEl = document.getElementById('profile-goals');
                    
                    if (nameEl) nameEl.value = savedProfile.name || 'Enter your name';
                    if (idEl) idEl.value = savedProfile.id || 'BATCH';
                    if (emailEl) emailEl.value = savedProfile.email || 'enter your mail';
                    if (courseEl) courseEl.value = savedProfile.course || 'enter course pursuing';
                    if (goalsEl) goalsEl.value = savedProfile.goals || '';
                    
                    // Load profile photo if available and update all profile photos
                    if (savedProfile.photo) {
                        updateAllProfilePhotos(savedProfile.photo);
                    }
                }
            } catch (e) {
                console.error('Error loading profile:', e);
            }

            // Initialize skills on page load
            let skillsInitAttempts = 0;
            const maxSkillsInitAttempts = 10; // Prevent infinite loops
            function initializeSkillsOnLoad() {
                // Check if skills container exists
                const skillsContainer = document.getElementById('skills-container');
                if (skillsContainer) {
                    initSkills();
                } else if (skillsInitAttempts < maxSkillsInitAttempts) {
                    // If not loaded yet, try again after a short delay
                    skillsInitAttempts++;
                    setTimeout(initializeSkillsOnLoad, 500);
                } else {
                    console.warn('Skills container not found after multiple attempts');
                }
            }
            
            // Initialize skills when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeSkillsOnLoad);
            } else {
                initializeSkillsOnLoad();
            }

            // ===== Routine Export =====
            const exportRoutineBtn = document.getElementById('exportRoutineBtn');
            if (exportRoutineBtn) {
                exportRoutineBtn.addEventListener('click', () => {
                const routineText = `Daily Routine - Monday, 29 September 2025
7:00 - Morning Routine (Completed)
9:00 - Data Structures Class (Completed)
10:00 - Algorithms Class (In Progress)
11:00 - Free Period - Suggested Activity (Upcoming)
12:00 - Lunch Break
14:00 - Database Systems Class (Not Started)
16:00 - Free Time - Suggested Activity (Not Started)`;
                const blob = new Blob([routineText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'daily_routine.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showMessage('Routine exported!');
            });
            }

            // ===== Neon Rescheduler System =====
            /* ===== in-memory ===== */
            let classes = []; // each: {id, name, subjects: [{name, teacher, avg}], timetable: [] }
            let absentTeachers = new Set();
            let periodCount = 6;

            /* ===== DOM refs ===== */
            const classesContainer = document.getElementById('classesContainer');
            const addClassBtn = document.getElementById('addClassBtn');
            const resetBtn = document.getElementById('resetBtn');
            const periodCountInput = document.getElementById('periodCount');
            const timetablesInputs = document.getElementById('timetablesInputs');
            const absentTeacherSelect = document.getElementById('absentTeacherSelect');
            const addAbsentBtn = document.getElementById('addAbsentBtn');
            const absentList = document.getElementById('absentList');
            const previewBtn = document.getElementById('previewBtn');
            const regenBtn = document.getElementById('regenBtn');
            const previewArea = document.getElementById('previewArea');

            const resultView = document.getElementById('resultView');
            const resultTablesContainer = document.getElementById('resultTablesContainer');
            const absentBadge = document.getElementById('absentBadge');
            const backBtn = document.getElementById('backBtn');
            const downloadBtn = document.getElementById('downloadBtn');

            /* ===== helpers ===== */
            function uid(prefix = 'id') { return prefix + Math.random().toString(36).slice(2, 9) }
            function clamp(v, min, max) { return Math.max(min, Math.min(max, v)) }
            function escapeHtml(s) { if (s === null || s === undefined) return ''; return ('' + s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c]) }

            /* ===== Classes CRUD ===== */
            function addClass(initial) {
                const id = uid('c');
                const cls = {
                    id,
                    name: initial?.name || `Class ${classes.length + 1}`,
                    subjects: initial?.subjects || [
                        { name: 'Math', teacher: 'Alice', avg: 50 },
                        { name: 'Science', teacher: 'Bob', avg: 60 }
                    ],
                    timetable: initial?.timetable || []
                };
                classes.push(cls);
                renderClasses();
                refreshAbsentSelect();
                renderTimetableInputs();
            }

            function removeClass(id) {
                classes = classes.filter(c => c.id !== id);
                renderClasses();
                refreshAbsentSelect();
                renderTimetableInputs();
            }

            function renderClasses() {
                classesContainer.innerHTML = '';
                classes.forEach((c, classIndex) => {
                    const card = document.createElement('div');
                    card.className = 'class-card';
                    card.innerHTML = `
                        <div class="class-title">
                            <div><input class="input" data-bind="name" value="${escapeHtml(c.name)}" /></div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn ghost small" data-remove="${c.id}">Remove</button>
                            </div>
                        </div>
                        <div style="margin-top:10px; font-size:13px; color:var(--muted)">Subjects (teacher + avg %). Add/remove subjects below.</div>
                        <div class="subjects" data-subjects-area="${c.id}"></div>
                        <div style="margin-top:8px">
                            <button class="btn ghost" data-add-sub="${c.id}">+ Add Subject</button>
                        </div>
                    `;
                    classesContainer.appendChild(card);

                    // bind name change
                    const nameInput = card.querySelector('[data-bind="name"]');
                    nameInput.addEventListener('input', (e) => {
                        c.name = e.target.value;
                        renderTimetableInputs();
                        refreshAbsentSelect();
                    });

                    // remove button
                    card.querySelector('[data-remove]').addEventListener('click', () => removeClass(c.id));

                    // render subjects area
                    const subjectsArea = card.querySelector(`[data-subjects-area="${c.id}"]`);
                    function renderSubjects() {
                        subjectsArea.innerHTML = '';
                        c.subjects.forEach((s, idx) => {
                            const chip = document.createElement('div');
                            chip.className = 'subject-chip';
                            chip.innerHTML = `
                                <div style="display:flex; gap:6px; align-items:center; justify-content:space-between;">
                                    <div style="text-align:left; min-width:150px;">
                                        <div style="font-weight:700">${escapeHtml(s.name)}</div>
                                        <small>Teacher: <input class="input" data-teacher data-idx="${idx}" value="${escapeHtml(s.teacher)}" style="width:140px"/></small>
                                        <small style="margin-left:8px">Avg: <input class="input" data-avg data-idx="${idx}" value="${escapeHtml(String(s.avg))}" style="width:80px" /></small>
                                    </div>
                                    <div>
                                        <button class="btn ghost" data-del-sub="${idx}">‚úï</button>
                                    </div>
                                </div>
                            `;
                            subjectsArea.appendChild(chip);

                            // delete subject (uses latest index by re-rendering)
                            chip.querySelector('[data-del-sub]').addEventListener('click', () => {
                                c.subjects.splice(idx, 1);
                                renderClasses();
                                renderTimetableInputs();
                                refreshAbsentSelect();
                            });

                            // update teacher & avg (use dataset idx so handler remains correct on re-render)
                            const teacherInput = chip.querySelector('[data-teacher]');
                            const avgInput = chip.querySelector('[data-avg]');
                            teacherInput.addEventListener('input', (e) => {
                                const i = Number(e.target.dataset.idx);
                                if (!Number.isNaN(i) && c.subjects[i]) {
                                    c.subjects[i].teacher = e.target.value;
                                    refreshAbsentSelect();
                                }
                            });
                            avgInput.addEventListener('input', (e) => {
                                const i = Number(e.target.dataset.idx);
                                if (!Number.isNaN(i) && c.subjects[i]) {
                                    const v = parseFloat(e.target.value);
                                    c.subjects[i].avg = Number.isFinite(v) ? clamp(v, 0, 100) : 0;
                                }
                            });
                        });
                    }
                    renderSubjects();

                    // add subject
                    card.querySelector('[data-add-sub]').addEventListener('click', () => {
                        c.subjects.push({ name: `Subject ${c.subjects.length + 1}`, teacher: `T${Math.random().toString(36).slice(2, 5)}`, avg: 50 });
                        renderClasses();
                        renderTimetableInputs();
                        refreshAbsentSelect();
                    });
                });
            }

            /* ===== Timetable inputs ===== */
            function renderTimetableInputs() {
                periodCount = Math.max(1, parseInt(periodCountInput.value) || 6);
                timetablesInputs.innerHTML = '';
                classes.forEach(c => {
                    // ensure timetable length
                    if (!Array.isArray(c.timetable) || c.timetable.length !== periodCount) {
                        c.timetable = Array.from({ length: periodCount }, (_, i) => c.subjects[i]?.name || (c.subjects[0] ? c.subjects[0].name : 'Free'));
                    }
                    const wrapper = document.createElement('div');
                    wrapper.style.minWidth = '320px';
                    wrapper.innerHTML = `<div style="font-weight:700; margin-bottom:6px">${escapeHtml(c.name)}</div>
                        <textarea class="input" rows="3" data-timearea="${c.id}">${escapeHtml(c.timetable.join(', '))}</textarea>
                        <div style="font-size:12px; color:var(--muted); margin-top:6px">Use subject names exactly (comma separated). Missing subjects will be left 'Free'.</div>`;
                    timetablesInputs.appendChild(wrapper);

                    const ta = wrapper.querySelector('[data-timearea]');
                    ta.addEventListener('change', () => {
                        const arr = ta.value.split(',').map(s => s.trim()).filter(s => s.length > 0);
                        // fill/trim to periodCount
                        while (arr.length < periodCount) arr.push('Free');
                        c.timetable = arr.slice(0, periodCount);
                        ta.value = c.timetable.join(', ');
                    });
                });
            }

            /* ===== Absent UI ===== */
            function refreshAbsentSelect() {
                const teachers = new Set();
                classes.forEach(c => c.subjects.forEach(s => {
                    const t = (s.teacher || '').trim();
                    if (t) teachers.add(t);
                }));
                const names = Array.from(teachers).sort();
                absentTeacherSelect.innerHTML = '';
                names.forEach(n => {
                    const opt = document.createElement('option'); opt.value = n; opt.textContent = n;
                    absentTeacherSelect.appendChild(opt);
                });
            }

            function renderAbsentList() {
                absentList.innerHTML = '';
                absentTeachers.forEach(t => {
                    const pill = document.createElement('div');
                    pill.className = 'subject-chip';
                    pill.style.display = 'inline-flex';
                    pill.style.gap = '8px';
                    pill.innerHTML = `<div style="min-width:120px">${escapeHtml(t)}</div><div><button class="btn ghost" data-remove="${escapeHtml(t)}">Remove</button></div>`;
                    absentList.appendChild(pill);
                    pill.querySelector('[data-remove]').addEventListener('click', () => {
                        absentTeachers.delete(t);
                        renderAbsentList();
                        absentBadge.textContent = `Absent: ${absentTeachers.size}`;
                    });
                });
                absentBadge.textContent = `Absent: ${absentTeachers.size}`;
            }

            /* ===== Preview ===== */
            function renderPreview() {
                previewArea.style.display = 'block';
                previewArea.innerHTML = '';
                if (classes.length === 0) {
                    previewArea.innerHTML = '<div style="color:var(--muted)">No classes yet.</div>';
                    return;
                }
                const tbl = document.createElement('table');
                tbl.className = 'grid';
                const thead = document.createElement('thead'), tbody = document.createElement('tbody');
                const headRow = document.createElement('tr');
                headRow.innerHTML = `<th>Period</th>` + classes.map(c => `<th>${escapeHtml(c.name)}</th>`).join('');
                thead.appendChild(headRow);

                for (let p = 0; p < periodCount; p++) {
                    const tr = document.createElement('tr');
                    const periodName = `P${p + 1}`;
                    const cols = [`<td>${periodName}</td>`];
                    classes.forEach(c => {
                        const subj = c.timetable[p] || 'Free';
                        const subjObj = c.subjects.find(s => s.name === subj);
                        const teacher = subjObj ? subjObj.teacher : '';
                        cols.push(`<td>
                            <div>${escapeHtml(subj)}</div>
                            <div class="slot-teacher">${escapeHtml(teacher || '')}</div>
                        </td>`);
                    });
                    tr.innerHTML = cols.join('');
                    tbody.appendChild(tr);
                }
                tbl.appendChild(thead); tbl.appendChild(tbody);
                previewArea.appendChild(tbl);
            }

            /* ===== Rescheduling core algorithm ===== */
            function regenerateScheduleModel() {
                // Build teacher map: teacherName -> {teacher, subjects:Set, pairs:[]}
                const teacherMap = new Map();
                classes.forEach(c => {
                    c.subjects.forEach(s => {
                        const t = (s.teacher || '').trim();
                        if (!t) return;
                        if (!teacherMap.has(t)) teacherMap.set(t, { teacher: t, subjects: new Set(), pairs: [] });
                        const entry = teacherMap.get(t);
                        entry.subjects.add(s.name);
                        entry.pairs.push({ classId: c.id, className: c.name, subjectName: s.name });
                    });
                });

                // absent set (use local copy for consistency)
                const absentSet = new Set(absentTeachers);

                // prepare new schedules (subjects only)
                const newSchedules = {};
                classes.forEach(c => newSchedules[c.id] = c.timetable.slice());

                // teacher occupied per period
                const teacherOccupiedAt = {}; // teacher -> {period:true}

                for (let p = 0; p < periodCount; p++) {
                    // build current assignments
                    const assignments = classes.map(c => {
                        const subj = c.timetable[p] || 'Free';
                        const subjObj = c.subjects.find(s => s.name === subj);
                        const teacher = subjObj ? subjObj.teacher : '';
                        const present = teacher ? !absentSet.has(teacher) : true;
                        return { classId: c.id, className: c.name, subj, teacher, present, classObj: c };
                    });

                    // mark occupied teachers (present original assignments)
                    assignments.forEach(a => {
                        if (a.teacher && a.present) {
                            teacherOccupiedAt[a.teacher] = teacherOccupiedAt[a.teacher] || {};
                            teacherOccupiedAt[a.teacher][p] = true;
                        }
                    });

                    // applicants: slots where assigned teacher is absent
                    const applicants = assignments.filter(a => !a.present);

                    // also gather free slots (optional fill)
                    const freeSlots = assignments.filter(a => a.subj === 'Free');

                    // build pool of available teachers (present & not occupied this period)
                    const availableTeachers = [];
                    teacherMap.forEach(info => {
                        const t = info.teacher;
                        if (absentSet.has(t)) return;
                        if (teacherOccupiedAt[t] && teacherOccupiedAt[t][p]) return;
                        availableTeachers.push({ teacher: t, subjects: Array.from(info.subjects) });
                    });

                    // helper: best teacher for class (returns {teacher, subject, avg} or null)
                    function bestTeacherForClass(classObj) {
                        const candidates = [];
                        availableTeachers.forEach(info => {
                            info.subjects.forEach(subj => {
                                const subObj = classObj.subjects.find(ss => ss.name === subj);
                                const avg = subObj ? (Number.isFinite(subObj.avg) ? subObj.avg : 100) : 80;
                                candidates.push({ teacher: info.teacher, subject: subj, avg });
                            });
                        });
                        if (candidates.length === 0) return null;
                        candidates.sort((a, b) => a.avg - b.avg);
                        return candidates[0];
                    }

                    // compute needs for applicants
                    const applicantNeeds = applicants.map(a => {
                        return { applicant: a, best: bestTeacherForClass(a.classObj) };
                    });

                    // sort applicants by their best.avg ascending (most needy first). nulls go last
                    applicantNeeds.sort((A, B) => {
                        const aVal = A.best ? A.best.avg : 1000;
                        const bVal = B.best ? B.best.avg : 1000;
                        return aVal - bVal;
                    });

                    // assign teachers to applicants
                    for (const an of applicantNeeds) {
                        const a = an.applicant;
                        const best = an.best;
                        if (!best) {
                            newSchedules[a.classId][p] = 'Free';
                            continue;
                        }
                        newSchedules[a.classId][p] = best.subject;
                        teacherOccupiedAt[best.teacher] = teacherOccupiedAt[best.teacher] || {};
                        teacherOccupiedAt[best.teacher][p] = true;
                        // remove teacher from available list
                        for (let i = availableTeachers.length - 1; i >= 0; i--) {
                            if (availableTeachers[i].teacher === best.teacher) availableTeachers.splice(i, 1);
                        }
                    }

                    // try to fill free slots with remaining teachers
                    if (availableTeachers.length > 0 && freeSlots.length > 0) {
                        const freeNeeds = freeSlots.map(f => {
                            const classObj = f.classObj;
                            const candidates = [];
                            availableTeachers.forEach(info => {
                                info.subjects.forEach(subj => {
                                    const subObj = classObj.subjects.find(ss => ss.name === subj);
                                    const avg = subObj ? (Number.isFinite(subObj.avg) ? subObj.avg : 100) : 80;
                                    candidates.push({ teacher: info.teacher, subject: subj, avg });
                                });
                            });
                            if (candidates.length === 0) return { free: f, best: null };
                            candidates.sort((a, b) => a.avg - b.avg);
                            return { free: f, best: candidates[0] };
                        });

                        freeNeeds.sort((a, b) => {
                            const av = a.best ? a.best.avg : 1000;
                            const bv = b.best ? b.best.avg : 1000;
                            return av - bv;
                        });

                        for (const fn of freeNeeds) {
                            if (!fn.best) continue;
                            const teacher = fn.best.teacher;
                            const subject = fn.best.subject;
                            newSchedules[fn.free.classId][p] = subject;
                            teacherOccupiedAt[teacher] = teacherOccupiedAt[teacher] || {};
                            teacherOccupiedAt[teacher][p] = true;
                            for (let i = availableTeachers.length - 1; i >= 0; i--) if (availableTeachers[i].teacher === teacher) availableTeachers.splice(i, 1);
                        }
                    }

                    // any remaining applicants that did not get assignment become Free
                    assignments.forEach(a => {
                        if (!a.present && newSchedules[a.classId][p] === a.subj) {
                            newSchedules[a.classId][p] = 'Free';
                        }
                    });

                } // end periods

                // convert newSchedules to result structure including chosen teacher name (prefer class's own teacher if available)
                const result = classes.map(c => {
                    const arr = newSchedules[c.id].slice();
                    const finalArr = arr.map(subj => {
                        if (subj === 'Free') return { subject: 'Free', teacher: '' };
                        // try find the teacher in same class subjects
                        const sObj = c.subjects.find(s => s.name === subj);
                        if (sObj && !absentTeachers.has(sObj.teacher)) return { subject: subj, teacher: sObj.teacher };
                        // otherwise pick any teacher (non-absent) from teacherMap that teaches subj
                        let teacher = '';
                        for (let [t, info] of teacherMap) {
                            if (absentTeachers.has(t)) continue;
                            if (info.subjects.has(subj)) {
                                teacher = t; break;
                            }
                        }
                        return { subject: subj, teacher };
                    });
                    return { classId: c.id, className: c.name, schedule: finalArr };
                });

                return { result, absentList: Array.from(absentTeachers) };
            }

            /* ===== UI wiring ===== */
            if (addClassBtn) {
            addClassBtn.addEventListener('click', () => addClass());
            }
            if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                if (!confirm('Reset all classes and inputs?')) return;
                classes = [];
                absentTeachers.clear();
                addClass({ name: 'Class 1' });
                addClass({ name: 'Class 2' });
                renderClasses();
                renderTimetableInputs();
                refreshAbsentSelect();
                renderAbsentList();
                previewArea.style.display = 'none';
            });
            }

            if (periodCountInput) {
            periodCountInput.addEventListener('change', () => renderTimetableInputs());
            }

            if (addAbsentBtn && absentTeacherSelect) {
            addAbsentBtn.addEventListener('click', () => {
                const t = absentTeacherSelect.value;
                if (!t) return;
                absentTeachers.add(t);
                renderAbsentList();
            });
            }

            if (previewBtn) {
            previewBtn.addEventListener('click', () => renderPreview());
            }

            if (regenBtn) {
            regenBtn.addEventListener('click', () => {
                if (classes.length === 0) { alert('Add at least one class.'); return; }
                const model = regenerateScheduleModel();
                showResult(model);
            });
            }

            // seed data
            addClass({
                name: 'Computer Science A', subjects: [
                    { name: 'Math', teacher: 'Alice', avg: 45 },
                    { name: 'Algorithms', teacher: 'Eve', avg: 40 },
                    { name: 'Databases', teacher: 'Bob', avg: 65 },
                ], timetable: ['Math', 'Algorithms', 'Databases', 'Math', 'Algorithms', 'Free']
            });
            addClass({
                name: 'Computer Science B', subjects: [
                    { name: 'Math', teacher: 'Carol', avg: 70 },
                    { name: 'Algorithms', teacher: 'Dave', avg: 55 },
                    { name: 'Databases', teacher: 'Bob', avg: 60 },
                ], timetable: ['Algorithms', 'Math', 'Databases', 'Math', 'Free', 'Databases']
            });

            refreshAbsentSelect();
            renderAbsentList();
            renderTimetableInputs();

            /* Result rendering */
            function showResult(model) {
                resultView.style.display = 'block';
                absentBadge.textContent = `Absent: ${model.absentList.length}`;
                resultTablesContainer.innerHTML = '';

                const legend = document.createElement('div');
                legend.style.marginBottom = '10px';
                legend.innerHTML = `<div style="color:var(--muted); font-size:13px">Legend: <strong style="color:#fff">Subject</strong> ‚Ä¢ <span style="color:var(--muted)">Teacher</span></div>`;
                resultTablesContainer.appendChild(legend);

                const { result } = model;
                const periodLabels = Array.from({ length: periodCount }, (_, i) => `P${i + 1}`);

                const bigTable = document.createElement('table'); bigTable.className = 'grid';
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = `<th>Period</th>` + result.map(r => `<th>${escapeHtml(r.className)}</th>`).join('');
                thead.appendChild(headerRow);
                bigTable.appendChild(thead);

                const tbody = document.createElement('tbody');
                for (let p = 0; p < periodCount; p++) {
                    const tr = document.createElement('tr');
                    const periodName = periodLabels[p];
                    let cols = `<td>${periodName}</td>`;
                    result.forEach(r => {
                        const cell = r.schedule[p];
                        const subject = escapeHtml(cell.subject);
                        const teacher = escapeHtml(cell.teacher);
                        cols += `<td>
                            <div style="font-weight:700; color: white">${subject === 'Free' ? '<span style="color:var(--muted)">Free</span>' : subject}</div>
                            <div style="font-size:12px; color:var(--muted); margin-top:6px">${teacher || ''}</div>
                        </td>`;
                    });
                    tr.innerHTML = cols;
                    tbody.appendChild(tr);
                }
                bigTable.appendChild(tbody);
                resultTablesContainer.appendChild(bigTable);
            }

            backBtn.addEventListener('click', () => {
                resultView.style.display = 'none';
            });

            downloadBtn.addEventListener('click', () => {
                const model = regenerateScheduleModel();
                const res = model.result;
                const headers = ['Period', ...res.map(r => r.className)];
                const periodLabels = Array.from({ length: periodCount }, (_, i) => `P${i + 1}`);
                let rows = [headers.join(',')];
                for (let p = 0; p < periodCount; p++) {
                    const row = [periodLabels[p]];
                    for (const r of res) {
                        const s = r.schedule[p];
                        const cell = s.subject + (s.teacher ? ` (${s.teacher})` : '');
                        row.push('"' + cell.replace(/"/g, '""') + '"');
                    }
                    rows.push(row.join(','));
                }
                const csv = rows.join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'regenerated_timetable.csv'; document.body.appendChild(a); a.click(); a.remove();
                URL.revokeObjectURL(url);
            });

            // Initialize the application
            loadModels();
        }

        // Teacher Dashboard Initialization
        function initializeTeacherDashboard() {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');

            const showMessage = (msg) => { 
                if (messageText) messageText.textContent = msg; 
                if (messageBox) messageBox.classList.remove('hidden'); 
            };
            const hideMessage = () => { 
                if (messageBox) messageBox.classList.add('hidden'); 
            };

            // Start Attendance Session
            const startAttendanceBtn = document.getElementById('start-attendance-btn');
            if (startAttendanceBtn) {
                startAttendanceBtn.addEventListener('click', () => {
                showMessage('Attendance session started! Students can now mark attendance.');
            });
            }

            // Load Timetable
            const loadTimetableBtn = document.getElementById('load-timetable-btn');
            if (loadTimetableBtn) {
                loadTimetableBtn.addEventListener('click', () => {
                showMessage('Timetable loaded successfully.');
            });
            }

            // Open Rescheduler
            const openReschedulerBtn = document.getElementById('open-rescheduler-btn');
            if (openReschedulerBtn) {
                openReschedulerBtn.addEventListener('click', () => {
                showMessage('Rescheduler opened. Manage absent teachers and regenerate schedules.');
            });
            }
        }

        // Admin Dashboard Initialization
        function initializeAdminDashboard() {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');

            const showMessage = (msg) => { 
                if (messageText) messageText.textContent = msg; 
                if (messageBox) messageBox.classList.remove('hidden'); 
            };
            const hideMessage = () => { 
                if (messageBox) messageBox.classList.add('hidden'); 
            };

            // Load data from localStorage
            function loadUsers() {
                try {
                    const data = localStorage.getItem('adminUsers');
                    if (!data) {
                        return { students: [], teachers: [] };
                    }
                    const parsed = JSON.parse(data);
                    // Validate structure
                    if (parsed && typeof parsed === 'object') {
                        if (!Array.isArray(parsed.students)) parsed.students = [];
                        if (!Array.isArray(parsed.teachers)) parsed.teachers = [];
                        return parsed;
                    }
                    return { students: [], teachers: [] };
                } catch (error) {
                    console.error('Error loading users:', error);
                    return { students: [], teachers: [] };
                }
            }

            function saveUsers(users) {
                try {
                    localStorage.setItem('adminUsers', JSON.stringify(users));
                } catch (error) {
                    console.error('Error saving users:', error);
                    showMessage('Error saving users. Storage may be full.');
                }
            }

            function loadBatches() {
                try {
                    const data = localStorage.getItem('adminBatches');
                    if (!data) {
                        return {};
                    }
                    const parsed = JSON.parse(data);
                    // Validate structure
                    if (parsed && typeof parsed === 'object') {
                        // Ensure all batch values are arrays
                        Object.keys(parsed).forEach(key => {
                            if (!Array.isArray(parsed[key])) {
                                parsed[key] = [];
                            }
                        });
                        return parsed;
                    }
                    return {};
                } catch (error) {
                    console.error('Error loading batches:', error);
                    return {};
                }
            }

            function saveBatches(batches) {
                try {
                    localStorage.setItem('adminBatches', JSON.stringify(batches));
                    // Verify the save was successful
                    const saved = localStorage.getItem('adminBatches');
                    if (!saved) {
                        throw new Error('Failed to save batches to localStorage');
                    }
                    return true;
                } catch (error) {
                    console.error('Error saving batches:', error);
                    if (error.name === 'QuotaExceededError') {
                        showMessage('Error: Browser storage is full. Please clear some data and try again.');
                    } else {
                        showMessage('Error saving batches. Please try again.');
                    }
                    return false;
                }
            }

            // User Management
            const userTypeSelect = document.getElementById('user-type-select');
            const emailInputContainer = document.getElementById('email-input-container');
            const userEmailInput = document.getElementById('user-email-input');
            const addUserBtn = document.getElementById('add-user-btn');

            // Show/hide email input based on user type selection
            if (userTypeSelect && emailInputContainer) {
                userTypeSelect.addEventListener('change', function() {
                    if (this.value) {
                        emailInputContainer.style.display = 'block';
                        if (addUserBtn) addUserBtn.disabled = false;
                    } else {
                        emailInputContainer.style.display = 'none';
                        if (addUserBtn) addUserBtn.disabled = true;
                    }
                });
            }

            // Add user functionality
            if (addUserBtn && userTypeSelect && userEmailInput) {
                addUserBtn.addEventListener('click', function() {
                    const userType = userTypeSelect.value;
                    const email = userEmailInput.value.trim();

                    if (!userType || !email) {
                        showMessage('Please select user type and enter email.');
                        return;
                    }

                    // Validate email format
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        showMessage('Please enter a valid email address.');
                        return;
                    }

                    const users = loadUsers();
                    const userList = users[userType + 's']; // 'student' -> 'students', 'teacher' -> 'teachers'

                    // Check if email already exists
                    if (userList.includes(email)) {
                        showMessage(`${userType.charAt(0).toUpperCase() + userType.slice(1)} with this email already exists.`);
                        return;
                    }

                    // Add user
                    userList.push(email);
                    saveUsers(users);

                    // Clear inputs
                    if (userEmailInput) userEmailInput.value = '';
                    if (userTypeSelect) userTypeSelect.value = '';
                    if (emailInputContainer) emailInputContainer.style.display = 'none';
                    if (addUserBtn) addUserBtn.disabled = true;

                    // Refresh display
                    renderUsers();
                    renderStudentsForBatch();
                    showMessage(`${userType.charAt(0).toUpperCase() + userType.slice(1)} added successfully!`);
                });
            }

            // Render users list
            function renderUsers() {
                const usersList = document.getElementById('users-list');
                if (!usersList) return;

                try {
                    const users = loadUsers();
                    let html = '';

                    if (users.students && users.students.length > 0) {
                        html += '<div class="mb-4"><h4 class="font-semibold text-purple-400 mb-2">Students</h4>';
                        users.students.forEach((email, index) => {
                            html += `<div class="flex items-center justify-between p-2 bg-gray-700 rounded mb-1">
                                <span class="text-sm">${escapeHtml(email)}</span>
                                <button class="text-red-400 hover:text-red-300 text-xs remove-user-btn" data-type="student" data-index="${index}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>`;
                        });
                        html += '</div>';
                    }

                    if (users.teachers && users.teachers.length > 0) {
                        html += '<div><h4 class="font-semibold text-purple-400 mb-2">Teachers</h4>';
                        users.teachers.forEach((email, index) => {
                            html += `<div class="flex items-center justify-between p-2 bg-gray-700 rounded mb-1">
                                <span class="text-sm">${escapeHtml(email)}</span>
                                <button class="text-red-400 hover:text-red-300 text-xs remove-user-btn" data-type="teacher" data-index="${index}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>`;
                        });
                        html += '</div>';
                    }

                    if (html === '') {
                        html = '<p class="text-gray-500 text-sm">No users added yet.</p>';
                    }

                    usersList.innerHTML = html;
                    
                    // Attach event listeners
                    usersList.querySelectorAll('.remove-user-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const type = this.getAttribute('data-type');
                            const index = parseInt(this.getAttribute('data-index'));
                            if (type && !isNaN(index)) {
                                removeUser(type, index);
                            }
                        });
                    });
                } catch (error) {
                    console.error('Error rendering users:', error);
                    usersList.innerHTML = '<p class="text-red-400 text-sm">Error loading users.</p>';
                }
            }

            // Remove user function (global for onclick)
            window.removeUser = function(type, index) {
                try {
                    const users = loadUsers();
                    const userList = users[type + 's'];
                    if (!userList || !Array.isArray(userList)) {
                        showMessage('Error: Invalid user list.');
                        return;
                    }
                    if (index < 0 || index >= userList.length) {
                        showMessage('Error: Invalid user index.');
                        return;
                    }
                    const email = userList[index];
                    userList.splice(index, 1);
                    saveUsers(users);
                    renderUsers();
                    renderStudentsForBatch();
                    showMessage(`${type.charAt(0).toUpperCase() + type.slice(1)} removed: ${email}`);
                } catch (error) {
                    console.error('Error removing user:', error);
                    showMessage('Error removing user. Please try again.');
                }
            };

            // Batch Management
            const createBatchBtn = document.getElementById('create-batch-btn');
            const batchSelect = document.getElementById('batch-select');
            const newBatchNameInput = document.getElementById('new-batch-name-input');
            const newBatchNameBtn = document.getElementById('new-batch-name-btn');
            const addToBatchBtn = document.getElementById('add-to-batch-btn');
            const studentsCheckboxList = document.getElementById('students-checkbox-list');
            const selectedStudents = document.getElementById('selected-students');

            let selectedStudentEmails = new Set();

            // Create batch button
            if (createBatchBtn) {
                createBatchBtn.addEventListener('click', function() {
                    const batchName = prompt('Enter batch name (e.g., CS2021, ME2022):');
                    if (batchName && batchName.trim()) {
                        try {
                            const batches = loadBatches();
                            const name = batchName.trim();
                            if (batches[name]) {
                                showMessage('Batch with this name already exists.');
                                return;
                            }
                            batches[name] = [];
                            const saved = saveBatches(batches);
                            if (!saved) {
                                showMessage('Error: Batch was not saved. Please try again.');
                                return;
                            }
                            
                            // Verify save
                            const savedBatches = loadBatches();
                            if (!savedBatches[name]) {
                                showMessage('Error: Batch was not saved. Please try again.');
                                return;
                            }
                            
                            renderBatches();
                            renderBatchSelect();
                            if (batchSelect) batchSelect.value = name;
                            showMessage(`Batch "${name}" created successfully!`);
                        } catch (error) {
                            console.error('Error creating batch:', error);
                            showMessage('Error creating batch. Please try again.');
                        }
                    }
                });
            }

            // Function to create batch from input
            function createBatchFromInput() {
                if (!newBatchNameInput) return;
                const batchName = newBatchNameInput.value.trim();
                if (!batchName) {
                    showMessage('Please enter a batch name.');
                    return;
                }
                try {
                    const batches = loadBatches();
                    if (batches[batchName]) {
                        showMessage('Batch with this name already exists.');
                        return;
                    }
                    batches[batchName] = [];
                    const saved = saveBatches(batches);
                    if (!saved) {
                        showMessage('Error: Batch was not saved. Please try again.');
                        return;
                    }
                    
                    // Verify save
                    const savedBatches = loadBatches();
                    if (!savedBatches[batchName]) {
                        showMessage('Error: Batch was not saved. Please try again.');
                        return;
                    }
                    
                    renderBatches();
                    renderBatchSelect();
                    if (batchSelect) batchSelect.value = batchName;
                    if (newBatchNameInput) {
                        newBatchNameInput.value = '';
                        newBatchNameInput.style.display = 'none';
                    }
                    showMessage(`Batch "${batchName}" created successfully!`);
                } catch (error) {
                    console.error('Error creating batch:', error);
                    showMessage('Error creating batch. Please try again.');
                }
            }

            // New batch name input toggle and creation
            if (newBatchNameBtn && newBatchNameInput) {
                newBatchNameBtn.addEventListener('click', function() {
                    const isHidden = newBatchNameInput.style.display === 'none' || 
                                   window.getComputedStyle(newBatchNameInput).display === 'none';
                    
                    if (isHidden) {
                        // Show input field
                        newBatchNameInput.style.display = 'block';
                        newBatchNameInput.focus();
                        newBatchNameBtn.innerHTML = '<i class="fas fa-check"></i>'; // Change icon to checkmark
                    } else {
                        // Create batch
                        createBatchFromInput();
                        newBatchNameBtn.innerHTML = '<i class="fas fa-plus"></i>'; // Reset icon
                    }
                });

                // Add Enter key handler to input field
                newBatchNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        createBatchFromInput();
                        newBatchNameBtn.innerHTML = '<i class="fas fa-plus"></i>'; // Reset icon
                    }
                });
            }

            // Render batch select dropdown
            function renderBatchSelect() {
                if (!batchSelect) return;
                try {
                    const batches = loadBatches();
                    const batchNames = Object.keys(batches);
                    batchSelect.innerHTML = '<option value="">-- Select or Create Batch --</option>' +
                        batchNames.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');
                } catch (error) {
                    console.error('Error rendering batch select:', error);
                    batchSelect.innerHTML = '<option value="">-- Error loading batches --</option>';
                }
            }

            // Render students for batch selection
            function renderStudentsForBatch() {
                if (!studentsCheckboxList) return;
                try {
                    const users = loadUsers();
                    const students = users.students || [];

                    if (students.length === 0) {
                        studentsCheckboxList.innerHTML = '<p class="text-gray-500 text-sm">No students available. Add students first.</p>';
                        return;
                    }

                    studentsCheckboxList.innerHTML = students.map((email, index) => `
                        <label class="flex items-center p-2 hover:bg-gray-600 rounded cursor-pointer">
                            <input type="checkbox" class="student-checkbox mr-2" value="${escapeHtml(email)}" data-index="${index}">
                            <span class="text-sm">${escapeHtml(email)}</span>
                        </label>
                    `).join('');

                    // Attach checkbox listeners
                    studentsCheckboxList.querySelectorAll('.student-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const email = this.value;
                            if (this.checked) {
                                selectedStudentEmails.add(email);
                            } else {
                                selectedStudentEmails.delete(email);
                            }
                            renderSelectedStudents();
                            updateAddToBatchButton();
                        });
                    });
                } catch (error) {
                    console.error('Error rendering students for batch:', error);
                    studentsCheckboxList.innerHTML = '<p class="text-red-400 text-sm">Error loading students.</p>';
                }
            }

            // Render selected students
            function renderSelectedStudents() {
                if (!selectedStudents) return;
                if (selectedStudentEmails.size === 0) {
                    selectedStudents.innerHTML = '<span class="text-gray-500 text-sm">No students selected</span>';
                    return;
                }

                selectedStudents.innerHTML = Array.from(selectedStudentEmails).map(email => {
                    // Properly escape email for onclick attribute
                    const safeEmail = escapeHtml(email).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    return `
                        <span class="bg-green-600 text-white px-3 py-1 rounded-full text-xs flex items-center gap-2" data-email="${escapeHtml(email)}">
                            ${escapeHtml(email)}
                            <button class="text-white hover:text-red-200 remove-selected-student-btn" data-email="${escapeHtml(email)}">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </span>
                    `;
                }).join('');
                
                // Attach event listeners instead of using onclick
                selectedStudents.querySelectorAll('.remove-selected-student-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const email = this.getAttribute('data-email');
                        if (email) {
                            removeSelectedStudent(email);
                        }
                    });
                });
            }

            // Remove selected student
            window.removeSelectedStudent = function(email) {
                if (!email) return;
                selectedStudentEmails.delete(email);
                // Uncheck checkbox - need to escape for querySelector
                if (studentsCheckboxList) {
                    const checkboxes = studentsCheckboxList.querySelectorAll('.student-checkbox');
                    checkboxes.forEach(checkbox => {
                        if (checkbox.value === email) {
                            checkbox.checked = false;
                        }
                    });
                }
                renderSelectedStudents();
                updateAddToBatchButton();
            };

            // Update add to batch button state
            function updateAddToBatchButton() {
                if (!addToBatchBtn || !batchSelect) return;
                addToBatchBtn.disabled = !(batchSelect.value && selectedStudentEmails.size > 0);
            }

            // Batch select change
            if (batchSelect) {
                batchSelect.addEventListener('change', function() {
                    updateAddToBatchButton();
                });
            }

            // Add selected students to batch
            if (addToBatchBtn && batchSelect) {
                addToBatchBtn.addEventListener('click', function() {
                    const batchName = batchSelect.value;
                    if (!batchName) {
                        showMessage('Please select a batch.');
                        return;
                    }

                    if (selectedStudentEmails.size === 0) {
                        showMessage('Please select at least one student.');
                        return;
                    }

                    try {
                        const batches = loadBatches();
                        if (!batches[batchName]) {
                            batches[batchName] = [];
                        }

                        const emailsToAdd = Array.from(selectedStudentEmails);
                        let addedCount = 0;
                        emailsToAdd.forEach(email => {
                            if (!batches[batchName].includes(email)) {
                                batches[batchName].push(email);
                                addedCount++;
                            }
                        });

                        if (addedCount === 0) {
                            showMessage('All selected students are already in this batch.');
                            return;
                        }

                        const saved = saveBatches(batches);
                        if (!saved) {
                            showMessage('Error: Failed to save batch. Please try again.');
                            return;
                        }
                        renderBatches();
                        selectedStudentEmails.clear();
                        renderSelectedStudents();
                        if (studentsCheckboxList) {
                            studentsCheckboxList.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
                        }
                        updateAddToBatchButton();
                        showMessage(`${addedCount} student(s) added to batch "${batchName}"!`);
                    } catch (error) {
                        console.error('Error adding students to batch:', error);
                        showMessage('Error adding students to batch. Please try again.');
                    }
                });
            }

            // Render batches list
            function renderBatches() {
                const batchesList = document.getElementById('batches-list');
                if (!batchesList) return;

                try {
                    const batches = loadBatches();
                    const batchNames = Object.keys(batches);

                    if (batchNames.length === 0) {
                        batchesList.innerHTML = '<p class="text-gray-500 text-sm">No batches created yet.</p>';
                        return;
                    }

                    batchesList.innerHTML = batchNames.map(batchName => {
                        const students = batches[batchName] || [];
                        // Escape batch name for onclick attribute
                        const safeBatchName = escapeHtml(batchName).replace(/'/g, "\\'");
                        return `
                            <div class="bg-gray-700 p-3 rounded mb-2">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-semibold text-green-400">${escapeHtml(batchName)}</h4>
                                    <button class="text-red-400 hover:text-red-300 text-xs" onclick="removeBatch('${safeBatchName}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="text-sm text-gray-300">
                                    <span class="font-semibold">${students.length}</span> student(s)
                                </div>
                                <div class="mt-2 text-xs text-gray-400 max-h-20 overflow-y-auto">
                                    ${students.length > 0 ? students.map(email => `<div>‚Ä¢ ${escapeHtml(email)}</div>`).join('') : '<div>No students in this batch</div>'}
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('Error rendering batches:', error);
                    batchesList.innerHTML = '<p class="text-red-400 text-sm">Error loading batches.</p>';
                }
            }

            // Remove batch function (global for onclick)
            window.removeBatch = function(batchName) {
                if (!batchName) return;
                if (!confirm(`Are you sure you want to delete batch "${batchName}"?`)) {
                    return;
                }
                try {
                    const batches = loadBatches();
                    if (!batches[batchName]) {
                        showMessage('Batch not found.');
                        return;
                    }
                    delete batches[batchName];
                    const saved = saveBatches(batches);
                    if (!saved) {
                        showMessage('Error: Failed to delete batch. Please try again.');
                        return;
                    }
                    renderBatches();
                    renderBatchSelect();
                    // Clear selection if deleted batch was selected
                    if (batchSelect && batchSelect.value === batchName) {
                        batchSelect.value = '';
                        updateAddToBatchButton();
                    }
                    showMessage(`Batch "${batchName}" deleted successfully!`);
                } catch (error) {
                    console.error('Error removing batch:', error);
                    showMessage('Error removing batch. Please try again.');
                }
            };

            // Helper function to escape HTML
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Initialize displays
            renderUsers();
            renderBatches();
            renderBatchSelect();
            renderStudentsForBatch();

            // Generate Report
            const generateReportBtn = document.getElementById('generate-report-btn');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', () => {
                showMessage('Attendance report generated.');
            });
            }

            // Edit Settings
            const editSettingsBtn = document.getElementById('edit-settings-btn');
            if (editSettingsBtn) {
                editSettingsBtn.addEventListener('click', () => {
                showMessage('System settings opened for editing.');
            });
            }

            // ===== Timetable Management =====
            function loadBatchTimetables() {
                try {
                    const data = localStorage.getItem('batchTimetables');
                    if (!data) return {};
                    const parsed = JSON.parse(data);
                    return parsed && typeof parsed === 'object' ? parsed : {};
                } catch (error) {
                    console.error('Error loading batch timetables:', error);
                    return {};
                }
            }

            function saveBatchTimetables(timetables) {
                try {
                    localStorage.setItem('batchTimetables', JSON.stringify(timetables));
                    return true;
                } catch (error) {
                    console.error('Error saving batch timetables:', error);
                    showMessage('Error saving timetable. Storage may be full.');
                    return false;
                }
            }

            const timetableBatchSelect = document.getElementById('timetable-batch-select');
            const timetableManagementContainer = document.getElementById('timetable-management-container');
            const timetableBody = document.getElementById('timetable-body');
            const addTimetableRowBtn = document.getElementById('add-timetable-row');
            const saveTimetableBtn = document.getElementById('save-timetable');

            // Populate batch select for timetable
            function renderTimetableBatchSelect() {
                if (!timetableBatchSelect) return;
                const batches = loadBatches();
                const batchNames = Object.keys(batches);
                timetableBatchSelect.innerHTML = '<option value="">-- Select Batch --</option>' +
                    batchNames.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');
            }

            // Load and render weekly timetable grid
            function loadTimetableGrid(batchName) {
                if (!timetableBody) return;
                const timetables = loadBatchTimetables();
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
                
                // Collect all time slots from all days
                const timeSlotsMap = new Map();
                
                days.forEach(day => {
                    const batchKey = `${batchName}_${day}`;
                    const dayTimetable = timetables[batchKey] || [];
                    dayTimetable.forEach(entry => {
                        const time = entry.time || '';
                        if (!timeSlotsMap.has(time)) {
                            timeSlotsMap.set(time, {
                                time: time,
                                Mon: { subject: '', room: '' },
                                Tue: { subject: '', room: '' },
                                Wed: { subject: '', room: '' },
                                Thu: { subject: '', room: '' },
                                Fri: { subject: '', room: '' }
                            });
                        }
                        const slot = timeSlotsMap.get(time);
                        slot[day] = { subject: entry.subject || '', room: entry.room || '' };
                    });
                });

                timetableBody.innerHTML = '';
                
                // Convert map to array and sort by time
                const timeSlots = Array.from(timeSlotsMap.values()).sort((a, b) => {
                    if (!a.time) return 1;
                    if (!b.time) return -1;
                    return a.time.localeCompare(b.time);
                });

                if (timeSlots.length === 0) {
                    // Add one default row
                    addTimetableRow();
                } else {
                    timeSlots.forEach(slot => {
                        addTimetableRow(
                            slot.time,
                            slot.Mon.subject, slot.Mon.room,
                            slot.Tue.subject, slot.Tue.room,
                            slot.Wed.subject, slot.Wed.room,
                            slot.Thu.subject, slot.Thu.room,
                            slot.Fri.subject, slot.Fri.room
                        );
                    });
                }
            }

            // Add row to weekly timetable grid
            function addTimetableRow(time = '', 
                monSubject = '', monRoom = '',
                tueSubject = '', tueRoom = '',
                wedSubject = '', wedRoom = '',
                thuSubject = '', thuRoom = '',
                friSubject = '', friRoom = '') {
                if (!timetableBody) return;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-600 p-2 bg-gray-800 sticky left-0 z-10">
                        <input type="time" class="w-full px-2 py-1 bg-gray-700 text-white border border-gray-600 rounded" 
                            value="${time}" placeholder="HH:MM">
                    </td>
                    <td class="border border-gray-600 p-2">
                        <input type="text" class="w-full px-2 py-1 mb-1 bg-gray-800 text-white border border-gray-600 rounded" 
                            value="${escapeHtml(monSubject)}" placeholder="Subject" data-day="Mon" data-type="subject">
                        <input type="text" class="w-full px-2 py-1 bg-gray-800 text-white border border-gray-600 rounded" 
                            value="${escapeHtml(monRoom)}" placeholder="Room" data-day="Mon" data-type="room">
                    </td>
                    <td class="border border-gray-600 p-2">
                        <input type="text" class="w-full px-2 py-1 mb-1 bg-gray-800 text-white border border-gray-600 rounded" 
                            value="${escapeHtml(tueSubject)}" placeholder="Subject" data-day="Tue" data-type="subject">
                        <input type="text" class="w-full px-2 py-1 bg-gray-800 text-white border border-gray-600 rounded" 
                            value="${escapeHtml(tueRoom)}" placeholder="Room" data-day="Tue" data-type="room">
                    </td>
                    <td class="border border-gray-600 p-2">
                        <input type="text" class="w-full px-2 py-1 mb-1 bg-gray-800 text-white border border-gray-600 rounded" 
                            value="${escapeHtml(wedSubject)}" placeholder="Subject" data-day="Wed" data-type="subject">
                        <input type="text" class="w-full px-2 py-1 bg-gray-800 text-white border border-gray-600 rounded" 
                            value="${escapeHtml(wedRoom)}" placeholder="Room" data-day="Wed" data-type="room">
                    </td>
                    <td class="border border-gray-600 p-2">
                        <input type="text" class="w-full px-2 py-1 mb-1 bg-gray-800 text-white border border-gray-600 rounded" 
                            value="${escapeHtml(thuSubject)}" placeholder="Subject" data-day="Thu" data-type="subject">
                        <input type="text" class="w-full px-2 py-1 bg-gray-800 text-white border border-gray-600 rounded" 
                            value="${escapeHtml(thuRoom)}" placeholder="Room" data-day="Thu" data-type="room">
                    </td>
                    <td class="border border-gray-600 p-2">
                        <input type="text" class="w-full px-2 py-1 mb-1 bg-gray-800 text-white border border-gray-600 rounded" 
                            value="${escapeHtml(friSubject)}" placeholder="Subject" data-day="Fri" data-type="subject">
                        <input type="text" class="w-full px-2 py-1 bg-gray-800 text-white border border-gray-600 rounded" 
                            value="${escapeHtml(friRoom)}" placeholder="Room" data-day="Fri" data-type="room">
                    </td>
                    <td class="border border-gray-600 p-2 bg-gray-800">
                        <button class="remove-timetable-row bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs w-full">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                timetableBody.appendChild(row);

                // Add remove row functionality
                const removeBtn = row.querySelector('.remove-timetable-row');
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        row.remove();
                    });
                }
            }

            // Save weekly timetable
            function saveTimetable() {
                const batchName = timetableBatchSelect ? timetableBatchSelect.value : '';
                
                if (!batchName) {
                    showMessage('Please select a batch.');
                    return;
                }

                if (!timetableBody) return;

                const rows = timetableBody.querySelectorAll('tr');
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
                const timetables = loadBatchTimetables();
                
                // Initialize all days for this batch
                days.forEach(day => {
                    const batchKey = `${batchName}_${day}`;
                    if (!timetables[batchKey]) {
                        timetables[batchKey] = [];
                    }
                });
                
                // Process each row
                rows.forEach(row => {
                    const timeInput = row.querySelector('input[type="time"]');
                    if (!timeInput) return;
                    
                    const time = timeInput.value.trim();
                    if (!time) return; // Skip rows without time
                    
                    // Process each day
                    days.forEach(day => {
                        const subjectInput = row.querySelector(`input[data-day="${day}"][data-type="subject"]`);
                        const roomInput = row.querySelector(`input[data-day="${day}"][data-type="room"]`);
                        
                        const subject = subjectInput ? subjectInput.value.trim() : '';
                        const room = roomInput ? roomInput.value.trim() : '';
                        
                        // Only add entry if there's at least subject or room
                        if (subject || room) {
                            const batchKey = `${batchName}_${day}`;
                            
                            // Check if entry with this time already exists
                            const existingIndex = timetables[batchKey].findIndex(e => e.time === time);
                            
                            if (existingIndex >= 0) {
                                // Update existing entry
                                timetables[batchKey][existingIndex] = { time, subject, room };
                            } else {
                                // Add new entry
                                timetables[batchKey].push({ time, subject, room });
                            }
                        }
                    });
                });
                
                // Sort entries by time for each day
                days.forEach(day => {
                    const batchKey = `${batchName}_${day}`;
                    if (timetables[batchKey]) {
                        timetables[batchKey].sort((a, b) => {
                            if (!a.time) return 1;
                            if (!b.time) return -1;
                            return a.time.localeCompare(b.time);
                        });
                    }
                });
                
                if (saveBatchTimetables(timetables)) {
                    showMessage(`Weekly timetable saved for ${batchName}!`);
                }
            }

            // Event listeners
            if (timetableBatchSelect) {
                timetableBatchSelect.addEventListener('change', function() {
                    const batchName = this.value;
                    if (batchName) {
                        if (timetableManagementContainer) {
                            timetableManagementContainer.classList.remove('hidden');
                        }
                        loadTimetableGrid(batchName);
                    } else {
                        if (timetableManagementContainer) {
                            timetableManagementContainer.classList.add('hidden');
                        }
                    }
                });
            }

            if (addTimetableRowBtn) {
                addTimetableRowBtn.addEventListener('click', () => addTimetableRow());
            }

            if (saveTimetableBtn) {
                saveTimetableBtn.addEventListener('click', saveTimetable);
            }

            // Initialize timetable batch select
            renderTimetableBatchSelect();
            
            // Store original renderBatchSelect before override
            const originalRenderBatchSelect = renderBatchSelect;
            
            // Override renderBatchSelect to also update timetable batch select
            renderBatchSelect = function() {
                if (originalRenderBatchSelect) {
                    originalRenderBatchSelect();
                }
                renderTimetableBatchSelect();
            };
            
            // Also update when batches are rendered
            const originalRenderBatches = renderBatches;
            renderBatches = function() {
                if (originalRenderBatches) {
                    originalRenderBatches();
                }
                renderTimetableBatchSelect();
            };

            // ===== Minimize/Collapse Sections =====
            function initMinimizeSections() {
                const minimizeButtons = document.querySelectorAll('.minimize-section-btn');
                minimizeButtons.forEach(btn => {
                    // Remove existing listener to prevent duplicates
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    
                    newBtn.addEventListener('click', function() {
                        const sectionId = this.getAttribute('data-section');
                        const content = document.getElementById(sectionId + '-content');
                        const icon = this.querySelector('i');
                        
                        if (content && icon) {
                            if (content.style.display === 'none') {
                                // Expand
                                content.style.display = '';
                                icon.classList.remove('fa-chevron-down');
                                icon.classList.add('fa-chevron-up');
                            } else {
                                // Collapse
                                content.style.display = 'none';
                                icon.classList.remove('fa-chevron-up');
                                icon.classList.add('fa-chevron-down');
                            }
                        }
                    });
                });
            }

            // Initialize minimize functionality
            initMinimizeSections();
        }

        // Global functions
        window.logout = logout;
        window.hideMessage = () => document.getElementById('message-box').classList.add('hidden');
    </script>

    <!-- Gemini Chat Widget -->
    <div id="gemini-chat-widget" class="gemini-chat-widget" style="display: none;">
        <div class="gemini-chat-header">
            <div class="gemini-icon">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="#4facfe">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                </svg>
            </div>
            <h3>Gemini AI Assistant</h3>
        </div>
        <div id="gemini-messages" class="gemini-chat-messages">
            <div class="gemini-message assistant">
                üëã Hi! I'm your Gemini AI assistant. How can I help you today?
            </div>
        </div>
        <div class="gemini-chat-input-container">
            <input type="text" id="gemini-input" class="gemini-chat-input" placeholder="Type your message..." />
            <button id="gemini-send" class="gemini-send-btn">Send</button>
        </div>
    </div>

    <button id="gemini-toggle" class="gemini-toggle-btn" title="Chat with Gemini AI">
        <svg viewBox="0 0 24 24">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
        </svg>
    </button>

    <script type="module">
        // Chat Widget Controller
        const widget = document.getElementById('gemini-chat-widget');
        const toggleBtn = document.getElementById('gemini-toggle');
        const sendBtn = document.getElementById('gemini-send');
        const input = document.getElementById('gemini-input');
        const messages = document.getElementById('gemini-messages');

        let isOpen = false;

        toggleBtn.addEventListener('click', () => {
            isOpen = !isOpen;
            widget.style.display = isOpen ? 'block' : 'none';
            toggleBtn.style.display = isOpen ? 'none' : 'flex';
            if (isOpen) input.focus();
        });

        // Add close on click outside
        document.addEventListener('click', (e) => {
            if (isOpen && !widget.contains(e.target) && e.target !== toggleBtn) {
                isOpen = false;
                widget.style.display = 'none';
                toggleBtn.style.display = 'flex';
            }
        });

        widget.addEventListener('click', (e) => e.stopPropagation());

        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;

            // Add user message
            const userMsg = document.createElement('div');
            userMsg.className = 'gemini-message user';
            userMsg.textContent = text;
            messages.appendChild(userMsg);

            input.value = '';
            sendBtn.disabled = true;

            // Add typing indicator
            const typing = document.createElement('div');
            typing.className = 'gemini-message assistant gemini-typing';
            typing.innerHTML = '<span></span><span></span><span></span>';
            messages.appendChild(typing);
            messages.scrollTop = messages.scrollHeight;

            try {
                // Wait for Gemini to be ready
                await new Promise(resolve => {
                    const check = () => {
                        if (window.geminiAI) resolve();
                        else setTimeout(check, 100);
                    };
                    check();
                });

                const response = await window.geminiAI.sendMessage(text);

                // Remove typing indicator
                typing.remove();

                // Add AI response
                const aiMsg = document.createElement('div');
                aiMsg.className = 'gemini-message assistant';
                aiMsg.textContent = response;
                messages.appendChild(aiMsg);
            } catch (error) {
                typing.remove();
                const errorMsg = document.createElement('div');
                errorMsg.className = 'gemini-message assistant';
                errorMsg.textContent = '‚ùå Error: ' + (error.message || 'Failed to get response');
                messages.appendChild(errorMsg);
            }

            sendBtn.disabled = false;
            messages.scrollTop = messages.scrollHeight;
        }

        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>

</html>
